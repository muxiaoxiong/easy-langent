# ç¬¬ä¸‰ç«  LangChainè¿›é˜¶ç»„ä»¶å®æ“

## å‰è¨€

ä¸Šä¸€ç« æˆ‘ä»¬äº†è§£äº†LangChainçš„â€œæ ¸å¿ƒâ€â€”â€”ç»„ä»¶ï¼ŒåŒ…æ‹¬æ¨¡å‹è°ƒç”¨ã€æç¤ºè¯æ¨¡æ¿ä»¥åŠè¾“å‡ºè§£æã€‚

ä»è¿™ä¸€ç« å¼€å§‹ï¼Œæˆ‘ä»¬å°†èšç„¦LangChainç”Ÿæ€ä¸­çš„æ ¸å¿ƒè¿›é˜¶ç»„ä»¶ï¼Œä»çŠ¶æ€ç®¡ç†ã€å¤–éƒ¨è¡ŒåŠ¨ä¸¤ä¸ªæ ¸å¿ƒç»´åº¦æ‹†è§£ç»„ä»¶åŸç†ï¼Œå†é€šè¿‡ç»„ä»¶ç»„åˆå®è·µæŒæ¡å¤æ‚åº”ç”¨çš„æ„å»ºæ–¹æ³•ã€‚

é€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œä½ å°†å…·å¤‡æ„å»ºå¸¦è®°å¿†ã€èƒ½äº¤äº’å¤–éƒ¨ç³»ç»Ÿçš„æ™ºèƒ½åº”ç”¨çš„èƒ½åŠ›ã€‚

Go Go Go ï¼Œæˆ‘ä»¬å°±å‡ºå‘å§ï¼

## 3.1 çŠ¶æ€ç®¡ç†å±‚ï¼ˆMemoryï¼‰ï¼šè®©æ¨¡å‹æ‹¥æœ‰è®°å¿†èƒ½åŠ›

å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„åŸç”Ÿè°ƒç”¨æ˜¯æ— çŠ¶æ€çš„ï¼Œå³æ¯æ¬¡å¯¹è¯éƒ½æ˜¯ç‹¬ç«‹çš„è¯·æ±‚ï¼Œæ— æ³•ä¸»åŠ¨è®°ä½ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚LangChainçš„Memoryç»„ä»¶æ­£æ˜¯ä¸ºè§£å†³è¿™ä¸€é—®é¢˜è€Œç”Ÿï¼Œå®ƒé€šè¿‡ç»“æ„åŒ–çš„æ–¹å¼å­˜å‚¨ã€ç®¡ç†å¯¹è¯å†å²ï¼Œè®©AIå…·å¤‡â€œè®°å¿†èƒ½åŠ›â€ã€‚

### 3.1.1 å¯¹è¯è®°å¿†çš„æœ¬è´¨ä¸ä½œç”¨

#### 3.1.1.1 æ ¸å¿ƒæœ¬è´¨

å…¶å®Memoryç»„ä»¶çš„å·¥ä½œé€»è¾‘ç‰¹åˆ«å¥½ç†è§£ï¼Œå°±åƒæˆ‘ä»¬èŠå¤©æ—¶è®°ç¬”è®°ä¸€æ ·ï¼š

æ¯æ¬¡ä½ å’ŒAIå¯¹è¯åï¼Œå®ƒä¼šæŠŠâ€œä½ è¯´çš„è¯â€å’Œâ€œå®ƒçš„å›å¤â€æ•´ç†å¥½å­˜èµ·æ¥ï¼ˆè¿™ä¸€æ­¥å«â€œå­˜å‚¨â€ï¼‰ï¼›ç­‰ä½ ä¸‹ä¸€æ¬¡æé—®æ—¶ï¼Œå®ƒä¼šå…ˆæŠŠä¹‹å‰å­˜çš„ç¬”è®°æ‹¿å‡ºæ¥ï¼Œå’Œä½ æ–°çš„é—®é¢˜æ‹¼åœ¨ä¸€èµ·å†äº¤ç»™LLMï¼ˆè¿™ä¸€æ­¥å«â€œæå–â€ï¼‰ã€‚è¿™æ ·LLMå°±èƒ½çœ‹åˆ°å®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œè‡ªç„¶å°±èƒ½è®°ä½ä½ ä¹‹å‰è¯´çš„å†…å®¹äº†ã€‚

ä»æŠ€æœ¯å®ç°ä¸Šï¼ŒMemoryç»„ä»¶é€šè¿‡ä¸¤ä¸ªæ ¸å¿ƒåŠ¨ä½œå®Œæˆå·¥ä½œï¼š

- å­˜å‚¨ï¼ˆSaveï¼‰ï¼šå°†æ¯ä¸€è½®çš„ç”¨æˆ·è¾“å…¥ï¼ˆHumanMessageï¼‰å’ŒAIè¾“å‡ºï¼ˆAIMessageï¼‰ä¿å­˜åˆ°æŒ‡å®šå­˜å‚¨ä»‹è´¨ï¼ˆå†…å­˜ã€æ•°æ®åº“ç­‰ï¼‰ï¼›

- æå–ï¼ˆLoadï¼‰ï¼šæ–°ä¸€è½®å¯¹è¯æ—¶ï¼Œä»å­˜å‚¨ä»‹è´¨ä¸­æå–å†å²å¯¹è¯ï¼Œæ³¨å…¥åˆ°Promptä¸­ä¾›LLMå‚è€ƒã€‚

#### 3.1.1.2 æ ¸å¿ƒä½œç”¨

è®°å¿†åŠŸèƒ½çœ‹ä¼¼ç®€å•ï¼Œä½†èƒ½å¸®æˆ‘ä»¬è§£å†³å¾ˆå¤šå®é™…é—®é¢˜ï¼š

- é¿å…é‡å¤æé—®ï¼šæ¯”å¦‚ä½ è¯´è¿‡â€œæˆ‘å«å°æ˜â€ï¼Œä¹‹åä¸ç”¨å†é‡å¤ï¼ŒAIä¹Ÿèƒ½å«å‡ºä½ çš„åå­—ï¼›
- æ”¯æ’‘å¤æ‚ä»»åŠ¡ï¼šæ¯”å¦‚ä½ è®©AIâ€œå…ˆæ¢³ç†æˆ‘çš„éœ€æ±‚ï¼Œå†ç”Ÿæˆæ–¹æ¡ˆâ€ï¼Œå®ƒèƒ½è®°ä½ä¸­é—´çš„éœ€æ±‚æ¢³ç†ç»“æœï¼Œä¸ä¼šä¸­é€”å¤±å¿†ï¼›
- ç®€åŒ–äº¤äº’ï¼šä¸ç”¨æ¯æ¬¡æé—®éƒ½æŠŠå‰å› åæœè¯´ä¸€éï¼Œæ¯”å¦‚é—®â€œè¿™ä¸ªç»„ä»¶æ€ä¹ˆç”¨ï¼Ÿâ€ï¼ŒAIçŸ¥é“ä½ è¯´çš„æ˜¯ä¹‹å‰èŠçš„Memoryç»„ä»¶ã€‚

### 3.1.2 ä¸‰ç§åŸºç¡€Memoryç»„ä»¶å®æ“

LangChainæä¾›äº†å¤šç§Memoryå®ç°ï¼Œé€‚ç”¨äºä¸åŒåœºæ™¯ã€‚æˆ‘ä»¬é‡ç‚¹å­¦æœ€å¸¸ç”¨çš„ä¸‰ç§â€”â€”å…¨é‡è®°å¿†ã€çª—å£è®°å¿†ã€æ‘˜è¦è®°å¿†ã€‚å®ƒä»¬å„æœ‰é€‚ç”¨åœºæ™¯ï¼Œå­¦ä¼šäº†å°±èƒ½åº”å¯¹å¤§éƒ¨åˆ†éœ€æ±‚ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒLangChain 0.2.xåŠä»¥ä¸Šç‰ˆæœ¬æ¨èä½¿ç”¨LCELï¼ˆLangChain Execution Logicï¼‰æ¶æ„ï¼Œé€šè¿‡ `RunnableWithMessageHistory` ç»“åˆ `BaseChatMessageHistory` æŠ½è±¡ç±»å®ç°å¯¹è¯è®°å¿†ç®¡ç†ï¼Œæ›¿ä»£åç»­ä¸æ”¯æŒçš„ `ConversationChain`ã€‚

LCELï¼ˆLangChain Execution Logicï¼‰æ˜¯ LangChain 0.2+ çš„æ ¸å¿ƒæ‰§è¡Œé€»è¾‘ï¼Œç”¨ç®¡é“ç¬¦ `|` æŠŠç»„ä»¶ä¸²æˆæµæ°´çº¿ï¼Œå‰ä¸€ä¸ªç»„ä»¶çš„è¾“å‡ºè‡ªåŠ¨ä½œä¸ºåä¸€ä¸ªçš„è¾“å…¥ï¼Œå°±åƒå·¥å‚çš„ç”Ÿäº§çº¿

æœ¬æ•™ç¨‹å°†åŸºäºè¯¥æ¶æ„åˆ†åˆ«å®ç°ä¸‰ç§æ ¸å¿ƒè®°å¿†æ¨¡å¼ï¼š

- **å…¨é‡è®°å¿†**ï¼šå®Œæ•´ä¿å­˜æ‰€æœ‰å¯¹è¯å†å²ï¼Œé€‚ç”¨äºçŸ­å¯¹è¯åœºæ™¯
- **çª—å£è®°å¿†**ï¼šä»…ä¿ç•™æœ€è¿‘Nè½®å¯¹è¯ï¼Œæ§åˆ¶Tokenæ¶ˆè€—
- **æ‘˜è¦è®°å¿†**ï¼šé€šè¿‡LLMç”Ÿæˆå¯¹è¯æ‘˜è¦æ›¿ä»£å®Œæ•´å†å²ï¼Œå¹³è¡¡ä¸Šä¸‹æ–‡è¿è´¯æ€§ä¸æ•ˆç‡

æ ¸å¿ƒä¼˜åŠ¿ï¼šæ”¯æŒå¤šä¼šè¯éš”ç¦»ï¼ˆé€šè¿‡session_idï¼‰ã€è‡ªåŠ¨ç®¡ç†å†å²æ¶ˆæ¯çš„æ³¨å…¥ä¸ä¿å­˜ã€é€‚é…ç°ä»£LLMæ¨¡å‹çš„ä¼šè¯äº¤äº’é€»è¾‘ã€‚

session_id æ˜¯ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸åŒ session_id çš„å¯¹è¯è®°å¿†ç›¸äº’éš”ç¦»ï¼Œå°±åƒå¾®ä¿¡ä¸åŒèŠå¤©çª—å£çš„è®°å½•äº’ä¸å¹²æ‰°

ã€å‰ç½®å‡†å¤‡ã€‘æ‰€æœ‰æ¡ˆä¾‹éœ€å…ˆå®Œæˆç¯å¢ƒé…ç½®ï¼š

```bash
# å®‰è£…å®Œæ•´ä¾èµ–ï¼ˆæ–°æ‰‹å¿…æ‰§è¡Œï¼‰
pip install langchain langchain-openai python-dotenv langchain-experimental
```

 **.env æ–‡ä»¶**ç¤ºä¾‹

```
 API_KEY=ä½ çš„deepseek-api-key
```

å®è·µä»£ç 

```python
import os
from dotenv import load_dotenv
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.runnables import RunnablePassthrough
from langchain_core.chat_history import BaseChatMessageHistory, InMemoryChatMessageHistory
from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_openai import ChatOpenAI

# åŠ è½½ç¯å¢ƒå˜é‡ï¼ˆç¡®ä¿.envæ–‡ä»¶ä¸­é…ç½®äº†API_KEYï¼‰
load_dotenv()
API_KEY = os.getenv("API_KEY")
BASE_URL = "https://api.deepseek.com"

# åˆå§‹åŒ–LLMæ¨¡å‹
llm = ChatOpenAI(
    api_key=API_KEY,
    base_url=BASE_URL,
    model="deepseek-chat",
    temperature=0.3  # é™ä½éšæœºæ€§ï¼Œä¿è¯è¾“å‡ºç¨³å®š
)
```

#### 3.1.2.1 å…¨é‡è®°å¿†

ä½¿ç”¨`InMemoryChatMessageHistory` å­˜å‚¨å®Œæ•´å¯¹è¯å†å²ï¼Œæ¯æ¬¡è°ƒç”¨æ—¶è‡ªåŠ¨æ³¨å…¥æ‰€æœ‰å†å²æ¶ˆæ¯åˆ°æç¤ºè¯ä¸­ï¼Œé€‚ç”¨äºå¯¹è¯è½®æ•°å°‘ã€éœ€è¦å®Œæ•´ä¸Šä¸‹æ–‡çš„åœºæ™¯ã€‚

```python
# 1. å®šä¹‰æç¤ºè¯æ¨¡æ¿ï¼ˆåŒ…å«å†å²æ¶ˆæ¯å ä½ç¬¦ï¼‰
full_memory_prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯å‹å¥½çš„å¯¹è¯åŠ©æ‰‹ï¼Œéœ€åŸºäºå®Œæ•´çš„å†å²å¯¹è¯å›ç­”ç”¨æˆ·é—®é¢˜ã€‚"),
    MessagesPlaceholder(variable_name="chat_history"),  # å†å²æ¶ˆæ¯å ä½ç¬¦
    ("human", "{user_input}")  # ç”¨æˆ·å½“å‰è¾“å…¥
])

# 2. æ„å»ºåŸºç¡€é“¾ï¼ˆæç¤ºè¯ + LLMï¼‰
base_chain = full_memory_prompt | llm

# 3. ä¼šè¯å†å²å­˜å‚¨ï¼ˆå†…å­˜æ¨¡å¼ï¼Œç”Ÿäº§ç¯å¢ƒå¯æ›¿æ¢ä¸ºæ•°æ®åº“å­˜å‚¨ï¼‰
full_memory_store = {}

# 4. å®šä¹‰ä¼šè¯å†å²è·å–å‡½æ•°ï¼ˆæ ¸å¿ƒï¼šè¿”å›å®Œæ•´å†å²ï¼‰
def get_full_memory_history(session_id: str) -> BaseChatMessageHistory:
    """æ ¹æ®session_idè·å–ä¼šè¯å†å²ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°çš„å†å²è®°å½•"""
    if session_id not in full_memory_store:
        full_memory_store[session_id] = InMemoryChatMessageHistory()
    return full_memory_store[session_id]

# 5. æ„å»ºå¸¦å…¨é‡è®°å¿†çš„å¯¹è¯é“¾
full_memory_chain = RunnableWithMessageHistory(
    runnable=base_chain,
    get_session_history=get_full_memory_history,
    input_messages_key="user_input",  # è¾“å…¥ä¸­ç”¨æˆ·é—®é¢˜çš„é”®å
    history_messages_key="chat_history"  # ä¼ å…¥æç¤ºè¯çš„å†å²æ¶ˆæ¯é”®å
)
```

**ChatPromptTemplate.from_messages** åˆ›å»ºäº†ä¸€ä¸ªå¯¹è¯æç¤ºæ¨¡æ¿ï¼Œå®ƒå°±åƒæ˜¯ç»™AIè®¾å®šäº†ä¸€ä¸ªâ€œå‰§æœ¬â€ï¼Œè§„å®šäº†å¯¹è¯çš„ç»“æ„å’Œè§’è‰²

**MessagesPlaceholder(variable_name="chat_history")**è¿™æ˜¯ä¸€ä¸ªå†å²æ¶ˆæ¯å ä½ç¬¦ã€‚è¿™æ˜¯å®ç°å¯¹è¯è®°å¿†ï¼ˆè®°å¿†åŠŸèƒ½ï¼‰çš„å…³é”®ã€‚å®ƒä¸åœ¨æ¨¡æ¿ä¸­å†™æ­»ä»»ä½•å†…å®¹ï¼Œè€Œæ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼ŒåŠ¨æ€åœ°å°†ä¹‹å‰çš„å¯¹è¯è®°å½•ï¼ˆæ¯”å¦‚ç”¨æˆ·ä¹‹å‰é—®äº†ä»€ä¹ˆï¼ŒAIå›ç­”äº†ä»€ä¹ˆï¼‰æ’å…¥åˆ°è¿™ä¸ªä½ç½®ã€‚è¿™æ ·ï¼ŒAIåœ¨å›ç­”æ–°é—®é¢˜æ—¶å°±èƒ½å‚è€ƒä¸Šä¸‹æ–‡ï¼Œå®ç°è¿è´¯çš„å¤šè½®å¯¹è¯

```
base_chain = full_memory_prompt | llm
```

è¿™è¡Œä»£ç ä½¿ç”¨ç®¡é“æ“ä½œç¬¦ `|`å°†ä¸¤ä¸ªç»„ä»¶è¿æ¥èµ·æ¥ï¼Œå½¢æˆäº†ä¸€ä¸ªç®€å•çš„å¤„ç†é“¾ï¼Œå…¶å«ä¹‰æ˜¯**å°†å‰ä¸€ä¸ªç»„ä»¶çš„è¾“å‡ºï¼Œä½œä¸ºåä¸€ä¸ªç»„ä»¶çš„è¾“å…¥**

- **æ‰§è¡Œ `prompt`**ï¼š`prompt`ç»„ä»¶æ¥æ”¶ä¸€ä¸ªåŒ…å« `input`ï¼ˆç”¨æˆ·æ–°é—®é¢˜ï¼‰å’Œ `history`ï¼ˆå†å²å¯¹è¯ï¼‰çš„å˜é‡å­—å…¸ï¼Œç„¶åæ ¹æ®æ¨¡æ¿ç”Ÿæˆä¸€ä¸ªç»“æ„åŒ–çš„æ¶ˆæ¯åˆ—è¡¨ã€‚

- **ç®¡é“ä¼ é€’ (`|`)**ï¼šè¿™ä¸ªç”Ÿæˆå¥½çš„æ¶ˆæ¯åˆ—è¡¨è¢«è‡ªåŠ¨ä¼ é€’ç»™ `llm`ï¼ˆå¤§å‹è¯­è¨€æ¨¡å‹ï¼Œå¦‚ GPT-4ï¼‰ã€‚

- **æ‰§è¡Œ `llm`**ï¼š`llm`ç»„ä»¶æ ¹æ®æ”¶åˆ°çš„æ¶ˆæ¯åˆ—è¡¨ï¼Œç”Ÿæˆä¸€æ®µè¿è´¯ä¸”ç¬¦åˆä¸Šä¸‹æ–‡çš„å›ç­”ã€‚

æµ‹è¯•éªŒè¯

```python
# æµ‹è¯•å¤šè½®å¯¹è¯ï¼ˆæŒ‡å®šsession_id=user_001ï¼Œéš”ç¦»ä¸åŒç”¨æˆ·ï¼‰
config = {"configurable": {"session_id": "user_001"}}

# ç¬¬ä¸€è½®å¯¹è¯
response1 = full_memory_chain.invoke({"user_input": "æˆ‘å«å°æ˜ï¼Œå–œæ¬¢ç¼–ç¨‹"}, config=config)
print("åŠ©æ‰‹å›å¤1ï¼š", response1.content)
# è¾“å‡ºç¤ºä¾‹ï¼šä½ å¥½å°æ˜ï¼ç¼–ç¨‹æ˜¯ä¸€é¡¹å¾ˆæœ‰åˆ›é€ åŠ›çš„æŠ€èƒ½ï¼Œä½ å¹³æ—¶å¸¸ç”¨ä»€ä¹ˆç¼–ç¨‹è¯­è¨€å‘¢ï¼Ÿ

# ç¬¬äºŒè½®å¯¹è¯ï¼ˆéªŒè¯è®°å¿†ï¼šè¯¢é—®å†å²ä¿¡æ¯ï¼‰
response2 = full_memory_chain.invoke({"user_input": "æˆ‘åˆšæ‰è¯´æˆ‘å–œæ¬¢ä»€ä¹ˆï¼Ÿ"}, config=config)
print("åŠ©æ‰‹å›å¤2ï¼š", response2.content)
# è¾“å‡ºç¤ºä¾‹ï¼šä½ åˆšæ‰è¯´ä½ å–œæ¬¢ç¼–ç¨‹å‘€ï½

# æŸ¥çœ‹å®Œæ•´å†å²è®°å½•
print("\nå…¨é‡è®°å¿†çš„å¯¹è¯å†å²ï¼š")
for msg in get_full_memory_history("user_001").messages:
    print(f"{msg.type}: {msg.content}")
```

è¿è¡Œç»“æœ

```
åŠ©æ‰‹å›å¤1ï¼š ä½ å¥½å°æ˜ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ï¼ç¼–ç¨‹æ˜¯ä¸ªéå¸¸æ£’çš„çˆ±å¥½ï¼Œèƒ½åˆ›é€ ã€è§£å†³é—®é¢˜ï¼Œè¿˜èƒ½å®ç°å„ç§æœ‰è¶£çš„æƒ³æ³•ã€‚ä½ ä¸»è¦å¯¹å“ªç§ç¼–ç¨‹è¯­è¨€æˆ–é¢†åŸŸæ„Ÿå…´è¶£å‘¢ï¼Ÿæ¯”å¦‚ç½‘é¡µå¼€å‘ã€æ•°æ®åˆ†æã€æ¸¸æˆè®¾è®¡ï¼Œè¿˜æ˜¯å…¶ä»–æ–¹å‘ï¼Ÿ ğŸ˜Š
åŠ©æ‰‹å›å¤2ï¼š ä½ åˆšæ‰æåˆ°ä½ å–œæ¬¢ç¼–ç¨‹ï¼éœ€è¦æˆ‘æ¨èä¸€äº›å­¦ä¹ èµ„æºã€é¡¹ç›®çµæ„Ÿï¼Œæˆ–è€…èŠèŠç¼–ç¨‹ç›¸å…³çš„è¯é¢˜å—ï¼Ÿ ğŸ˜„
åŠ©æ‰‹å›å¤3ï¼š ä½ åˆšæ‰å‘Šè¯‰æˆ‘ï¼Œä½ çš„åå­—æ˜¯**å°æ˜**ï¼éœ€è¦æˆ‘å¸®ä½ è®°å½•æˆ–è§„åˆ’ä¸ç¼–ç¨‹ç›¸å…³çš„å­¦ä¹ ç›®æ ‡å—ï¼Ÿ ğŸ˜Š

å…¨é‡è®°å¿†çš„å¯¹è¯å†å²ï¼š
human: æˆ‘å«å°æ˜ï¼Œå–œæ¬¢ç¼–ç¨‹
ai: ä½ å¥½å°æ˜ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ï¼ç¼–ç¨‹æ˜¯ä¸ªéå¸¸æ£’çš„çˆ±å¥½ï¼Œèƒ½åˆ›é€ ã€è§£å†³é—®é¢˜ï¼Œè¿˜èƒ½å®ç°å„ç§æœ‰è¶£çš„æƒ³æ³•ã€‚ä½ ä¸»è¦å¯¹å“ªç§ç¼–ç¨‹è¯­è¨€æˆ–é¢†åŸŸæ„Ÿå…´è¶£å‘¢ï¼Ÿæ¯”å¦‚ç½‘é¡µå¼€å‘ã€æ•°æ®åˆ†æã€æ¸¸æˆè®¾è®¡ï¼Œè¿˜æ˜¯å…¶ä»–æ–¹å‘ï¼Ÿ  ğŸ˜Š
human: æˆ‘åˆšæ‰è¯´æˆ‘å–œæ¬¢ä»€ä¹ˆï¼Ÿ
ai: ä½ åˆšæ‰æåˆ°ä½ å–œæ¬¢ç¼–ç¨‹ï¼éœ€è¦æˆ‘æ¨èä¸€äº›å­¦ä¹ èµ„æºã€é¡¹ç›®çµæ„Ÿï¼Œæˆ–è€…èŠèŠç¼–ç¨‹ç›¸å…³çš„è¯é¢˜å—ï¼Ÿ ğŸ˜„
human: æˆ‘å«ä»€ä¹ˆåå­—
ai: ä½ åˆšæ‰å‘Šè¯‰æˆ‘ï¼Œä½ çš„åå­—æ˜¯**å°æ˜**ï¼éœ€è¦æˆ‘å¸®ä½ è®°å½•æˆ–è§„åˆ’ä¸ç¼–ç¨‹ç›¸å…³çš„å­¦ä¹ ç›®æ ‡å—ï¼Ÿ ğŸ˜Š
```

é€šè¿‡è¿è¡Œç»“æœå¯ä»¥å‘ç°ï¼šå…¨é‡è®°å¿†ä¼šå®Œæ•´ä¿å­˜æ‰€æœ‰å¯¹è¯å†å²ï¼ŒAI èƒ½å‡†ç¡®å›ç­”æ‰€æœ‰åŸºäºå†å²çš„é—®é¢˜ï¼Œé€‚åˆçŸ­å¯¹è¯åœºæ™¯ã€‚

#### 3.1.2.2 çª—å£è®°å¿†

å…¨é‡è®°å¿†é€‚åˆçŸ­å¯¹è¯ï¼Œé‚£é•¿å¯¹è¯æ€ä¹ˆåŠï¼Ÿ

è¿™æ—¶å€™å°±éœ€è¦â€œçª—å£è®°å¿†â€â€”â€”å®ƒåªä¿ç•™æœ€è¿‘çš„Nè½®å¯¹è¯ï¼ˆNç”¨kå‚æ•°æ§åˆ¶ï¼‰ï¼Œæ—©æœŸçš„å¯¹è¯ä¼šè‡ªåŠ¨ä¸¢å¼ƒã€‚è¿™æ ·èƒ½æœ‰æ•ˆæ§åˆ¶æ–‡å­—é‡ï¼Œé€‚åˆå®¢æœã€é•¿æœŸé™ªä¼´ç­‰é•¿å¯¹è¯åœºæ™¯ã€‚

```python
# 1. å®šä¹‰æç¤ºè¯æ¨¡æ¿ï¼ˆä¸å…¨é‡è®°å¿†é€šç”¨ï¼Œå¯å¤ç”¨ï¼‰
window_memory_prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯å‹å¥½çš„å¯¹è¯åŠ©æ‰‹ï¼Œéœ€åŸºäºæœ€è¿‘çš„å¯¹è¯å†å²å›ç­”ç”¨æˆ·é—®é¢˜ã€‚"),
    MessagesPlaceholder(variable_name="chat_history"),
    ("human", "{user_input}")
])

# 2. æ„å»ºåŸºç¡€é“¾
window_base_chain = window_memory_prompt | llm

# 3. ä¼šè¯å†å²å­˜å‚¨
window_memory_store = {}
WINDOW_SIZE = 2  # ä¿ç•™æœ€è¿‘2è½®å¯¹è¯ï¼ˆå³æœ€è¿‘4æ¡æ¶ˆæ¯ï¼šç”¨æˆ·-åŠ©æ‰‹-ç”¨æˆ·-åŠ©æ‰‹ï¼‰

# 4. å®šä¹‰å¸¦çª—å£é™åˆ¶çš„ä¼šè¯å†å²è·å–å‡½æ•°
def get_window_memory_history(session_id: str) -> BaseChatMessageHistory:
    """è·å–ä¼šè¯å†å²ï¼Œä»…ä¿ç•™æœ€è¿‘WINDOW_SIZEè½®å¯¹è¯"""
    if session_id not in window_memory_store:
        window_memory_store[session_id] = InMemoryChatMessageHistory()
    
    # è·å–å®Œæ•´å†å²ï¼Œæˆªå–æœ€è¿‘WINDOW_SIZEè½®ï¼ˆæ¯è½®2æ¡æ¶ˆæ¯ï¼‰
    history = window_memory_store[session_id]
    if len(history.messages) > 2 * WINDOW_SIZE:
        # æˆªå–åWINDOW_SIZEè½®æ¶ˆæ¯ï¼ˆä¿ç•™æœ€æ–°çš„ï¼‰
        history.messages = history.messages[-2 * WINDOW_SIZE:]
    return history

# 5. æ„å»ºå¸¦çª—å£è®°å¿†çš„å¯¹è¯é“¾
window_memory_chain = RunnableWithMessageHistory(
    runnable=window_base_chain,
    get_session_history=get_window_memory_history,
    input_messages_key="user_input",
    history_messages_key="chat_history"
)
```

æµ‹è¯•éªŒè¯

```python
# æµ‹è¯•å¤šè½®å¯¹è¯ï¼ˆsession_id=user_002ï¼Œä¸å…¨é‡è®°å¿†ä¼šè¯éš”ç¦»ï¼‰
config = {"configurable": {"session_id": "user_002"}}

# æ¨¡æ‹Ÿ5è½®å¯¹è¯ï¼ŒéªŒè¯çª—å£è®°å¿†çš„æˆªæ–­æ•ˆæœ
inputs = [
    "æˆ‘å«å°çº¢",
    "æˆ‘å–œæ¬¢ç”»ç”»",
    "æˆ‘æ¥è‡ªä¸Šæµ·",
    "æˆ‘æ˜¯ä¸€åå­¦ç”Ÿ",
    "æˆ‘åˆšæ‰è¯´æˆ‘æ¥è‡ªå“ªé‡Œï¼Ÿ"  # ç¬¬5è½®ï¼šè¯¢é—®ç¬¬3è½®çš„ä¿¡æ¯ï¼ŒéªŒè¯çª—å£æˆªæ–­
]

for i, user_input in enumerate(inputs, 1):
    response = window_memory_chain.invoke({"user_input": user_input}, config=config)
    print(f"\nç¬¬{i}è½® - åŠ©æ‰‹å›å¤ï¼š", response.content)

# æŸ¥çœ‹çª—å£è®°å¿†çš„æœ€ç»ˆå†å²ï¼ˆä»…ä¿ç•™æœ€è¿‘2è½®ï¼‰
print("\nçª—å£è®°å¿†çš„æœ€ç»ˆå¯¹è¯å†å²ï¼ˆæœ€è¿‘2è½®ï¼‰ï¼š")
for msg in get_window_memory_history("user_002").messages:
    print(f"{msg.type}: {msg.content}")
```

è¿è¡Œç»“æœ

```
ç¬¬1è½® - åŠ©æ‰‹å›å¤ï¼š ä½ å¥½å°çº¢ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ

ç¬¬2è½® - åŠ©æ‰‹å›å¤ï¼š ç”»ç”»æ˜¯å¾ˆæ£’çš„çˆ±å¥½å‘¢ï¼ä½ é€šå¸¸å–œæ¬¢ç”»ä»€ä¹ˆç±»å‹çš„ä½œå“ï¼Ÿæ¯”å¦‚é£æ™¯ã€äººç‰©ï¼Œè¿˜æ˜¯æŠ½è±¡ç”»ï¼Ÿ

ç¬¬3è½® - åŠ©æ‰‹å›å¤ï¼š ä¸Šæµ·æ˜¯ä¸ªå……æ»¡è‰ºæœ¯æ°”æ¯çš„åŸå¸‚å‘¢ï¼é‚£é‡Œæœ‰å¾ˆå¤šç¾æœ¯é¦†å’Œåˆ›æ„å›­åŒºï¼Œæ¯”å¦‚è¥¿å²¸è‰ºæœ¯ä¸­å¿ƒã€M50åˆ›æ„å›­ï¼Œè¯´ä¸å®šèƒ½ç»™ä½ çš„åˆ›ä½œå¸¦æ¥çµæ„Ÿå“¦ï½

ç¬¬4è½® - åŠ©æ‰‹å›å¤ï¼š å­¦ç”Ÿæ—¶æœŸèƒ½æœ‰æ—¶é—´åšæŒçˆ±å¥½çœŸä¸å®¹æ˜“å‘¢ï¼ä½ æ˜¯é€šè¿‡å­¦æ ¡ç¤¾å›¢ã€è¯¾å¤–ç­è‡ªå­¦ï¼Œè¿˜æ˜¯çº¯ç²¹å½“ä½œæ”¾æ¾çš„æ–¹å¼å‘¢ï¼Ÿ

ç¬¬5è½® - åŠ©æ‰‹å›å¤ï¼š ä½ åˆšæ‰æåˆ°ä½ æ¥è‡ªä¸Šæµ·ï½éœ€è¦æˆ‘å¸®ä½ æ¨èäº›é€‚åˆå­¦ç”Ÿå‚è§‚çš„è‰ºæœ¯å±•è§ˆæˆ–åˆ›æ„å¸‚é›†å—ï¼Ÿ(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§

çª—å£è®°å¿†çš„æœ€ç»ˆå¯¹è¯å†å²ï¼ˆæœ€è¿‘2è½®ï¼‰ï¼š
human: æˆ‘æ˜¯ä¸€åå­¦ç”Ÿ
ai: å­¦ç”Ÿæ—¶æœŸèƒ½æœ‰æ—¶é—´åšæŒçˆ±å¥½çœŸä¸å®¹æ˜“å‘¢ï¼ä½ æ˜¯é€šè¿‡å­¦æ ¡ç¤¾å›¢ã€è¯¾å¤–ç­è‡ªå­¦ï¼Œè¿˜æ˜¯çº¯ç²¹å½“ä½œæ”¾æ¾çš„æ–¹å¼å‘¢ï¼Ÿ
human: æˆ‘åˆšæ‰è¯´æˆ‘æ¥è‡ªå“ªé‡Œï¼Ÿ
ai: ä½ åˆšæ‰æåˆ°ä½ æ¥è‡ªä¸Šæµ·ï½éœ€è¦æˆ‘å¸®ä½ æ¨èäº›é€‚åˆå­¦ç”Ÿå‚è§‚çš„è‰ºæœ¯å±•è§ˆæˆ–åˆ›æ„å¸‚é›†å—ï¼Ÿ(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§
```

>æ³¨æ„ï¼šçª—å£è®°å¿†ä»…ä¿ç•™æœ€è¿‘ 2 è½®å¯¹è¯ï¼Œç¬¬ 3 è½® â€œæ¥è‡ªä¸Šæµ·â€ çš„ä¿¡æ¯è¢«æˆªæ–­ï¼Œå› æ­¤ AI æ— æ³•å›ç­”è¯¥é—®é¢˜ï¼Œç¬¦åˆé¢„æœŸé€»è¾‘ã€‚

#### 3.1.2.3 æ‘˜è¦è®°å¿†

å¦‚æœéœ€è¦è¶…é•¿æ—¶é—´çš„å¯¹è¯ï¼ˆæ¯”å¦‚å‡ å°æ—¶çš„å’¨è¯¢ï¼‰ï¼Œå³ä½¿æ˜¯çª—å£è®°å¿†ä¹Ÿå¯èƒ½ä¸å¤Ÿç”¨ã€‚è¿™æ—¶å€™å°±éœ€è¦â€œæ‘˜è¦è®°å¿†â€â€”â€”å®ƒä¸ä¿å­˜å¯¹è¯åŸæ–‡ï¼Œè€Œæ˜¯ç”¨LLMæŠŠå†å²å¯¹è¯æ€»ç»“æˆä¸€æ®µç®€æ´çš„æ‘˜è¦ã€‚æ—¢èƒ½ä¿ç•™æ ¸å¿ƒä¿¡æ¯ï¼Œåˆèƒ½æœ€å¤§ç¨‹åº¦èŠ‚çœæ–‡å­—é‡ï¼Œç¼ºç‚¹æ˜¯å¯èƒ½ä¼šä¸¢å¤±ä¸€äº›ç»†èŠ‚ï¼ˆæ¯”å¦‚å…·ä½“çš„æ•°å­—ã€åå­—ï¼‰ã€‚

```python
# 1. å®šä¹‰æ‘˜è¦ç”Ÿæˆæç¤ºè¯ï¼ˆç”¨äºå‹ç¼©å¯¹è¯å†å²ï¼‰
summary_prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯å¯¹è¯æ‘˜è¦åŠ©æ‰‹ï¼Œéœ€ç®€æ´æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„æ ¸å¿ƒä¿¡æ¯ï¼ˆåŒ…å«ç”¨æˆ·èº«ä»½ã€åå¥½ã€å…³é”®é—®é¢˜ç­‰ï¼‰ï¼Œä¸è¶…è¿‡50å­—ã€‚"),
    ("human", "å¯¹è¯å†å²ï¼š{chat_history_text}\nè¯·ç”Ÿæˆæ‘˜è¦ï¼š")
])

# 2. æ„å»ºæ‘˜è¦ç”Ÿæˆé“¾ï¼ˆè¾“å…¥å®Œæ•´å†å²æ–‡æœ¬ï¼Œè¾“å‡ºæ‘˜è¦ï¼‰
summary_chain = summary_prompt | llm

# 3. å®šä¹‰å¯¹è¯è®°å¿†æç¤ºè¯ï¼ˆæ³¨å…¥æ‘˜è¦è€Œéå®Œæ•´å†å²ï¼‰
summary_memory_prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯å‹å¥½çš„å¯¹è¯åŠ©æ‰‹ï¼Œéœ€åŸºäºå¯¹è¯æ‘˜è¦å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œæ‘˜è¦åŒ…å«æ ¸å¿ƒä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚"),
    ("system", "å¯¹è¯æ‘˜è¦ï¼š{chat_summary}"),  # æ³¨å…¥æ‘˜è¦
    ("human", "{user_input}")
])

# 4. æ„å»ºåŸºç¡€å¯¹è¯é“¾ï¼ˆæç¤ºè¯ + LLMï¼‰
summary_base_chain = (
    RunnablePassthrough.assign(
        chat_summary=lambda x: summary_chain.invoke(
            {
                "chat_history_text": "\n".join(
                    [f"{msg.type}: {msg.content}" for msg in x["chat_history"]]
                )
            }
        ).content
    )
    | summary_memory_prompt
    | llm
)

# 5. ä¼šè¯å†å²å­˜å‚¨ï¼ˆä¿å­˜å®Œæ•´å†å²ç”¨äºç”Ÿæˆæ‘˜è¦ï¼‰
summary_memory_store = {}

# 6. å®šä¹‰ä¼šè¯å†å²è·å–å‡½æ•°
def get_summary_memory_history(session_id: str) -> BaseChatMessageHistory:
    if session_id not in summary_memory_store:
        summary_memory_store[session_id] = InMemoryChatMessageHistory()
    return summary_memory_store[session_id]

# 7. æ„å»ºå¸¦æ‘˜è¦è®°å¿†çš„å¯¹è¯é“¾
summary_memory_chain = RunnableWithMessageHistory(
    runnable=summary_base_chain,
    get_session_history=get_summary_memory_history,
    input_messages_key="user_input",
    history_messages_key="chat_history"  # ä¼ å…¥å®Œæ•´å†å²ç”¨äºç”Ÿæˆæ‘˜è¦
)
```

æµ‹è¯•éªŒè¯

```python
# æµ‹è¯•å¤šè½®å¯¹è¯ï¼ˆsession_id=user_003ï¼‰
config = {"configurable": {"session_id": "user_003"}}

# å¤šè½®å¯¹è¯è¾“å…¥
inputs = [
    "æˆ‘å«å°æï¼Œæ˜¯ä¸€åäº§å“ç»ç†",
    "æˆ‘è´Ÿè´£ä¸€æ¬¾ç”µå•†APPçš„è¿­ä»£",
    "æœ€è¿‘åœ¨ä¼˜åŒ–ç”¨æˆ·ä¸‹å•æµç¨‹",
    "é‡åˆ°äº†ç”¨æˆ·æµå¤±ç‡é«˜çš„é—®é¢˜",
    "ä½ èƒ½ç»™æˆ‘ä¸€äº›ä¼˜åŒ–å»ºè®®å—ï¼Ÿ"
]

for i, user_input in enumerate(inputs, 1):
    response = summary_memory_chain.invoke({"user_input": user_input}, config=config)
    print(f"\nç¬¬{i}è½® - åŠ©æ‰‹å›å¤ï¼š", response.content)

# æŸ¥çœ‹å®Œæ•´å†å²ä¸æœ€ç»ˆæ‘˜è¦
history = get_summary_memory_history("user_003")
print("\næ‘˜è¦è®°å¿†çš„å®Œæ•´å¯¹è¯å†å²ï¼š")
for msg in history.messages:
    print(f"{msg.type}: {msg.content}")

# å•ç‹¬ç”Ÿæˆæœ€ç»ˆæ‘˜è¦éªŒè¯
final_summary = summary_chain.invoke({
    "chat_history_text": "\n".join([f"{msg.type}: {msg.content}" for msg in history.messages])
}).content
print(f"\næœ€ç»ˆå¯¹è¯æ‘˜è¦ï¼š{final_summary}")
# è¾“å‡ºç¤ºä¾‹ï¼šæ‘˜è¦ï¼šå°æï¼Œäº§å“ç»ç†ï¼Œè´Ÿè´£ç”µå•†APPè¿­ä»£ï¼Œä¼˜åŒ–ä¸‹å•æµç¨‹æ—¶é‡ç”¨æˆ·æµå¤±ç‡é«˜é—®é¢˜ï¼Œå¯»æ±‚å»ºè®®ã€‚
```

è¿è¡Œç»“æœ

```
ç¬¬1è½® - åŠ©æ‰‹å›å¤ï¼š ä½ å¥½å°æï¼å¾ˆé«˜å…´è®¤è¯†ä½ ï¼ä½œä¸ºäº§å“ç»ç†ï¼Œä½ çš„å·¥ä½œä¸€å®šå……æ»¡æŒ‘æˆ˜å’Œåˆ›æ„å§ï¼Ÿå¦‚æœéœ€è¦è®¨è®ºäº§å“è®¾è®¡ã€ç”¨æˆ·éœ€æ±‚æˆ–ä»»ä½•ç›¸å…³è¯é¢˜ï¼Œæˆ‘éšæ—¶å¯ä»¥å¸®å¿™å“¦ï¼ ğŸ˜Š

ç¬¬2è½® - åŠ©æ‰‹å›å¤ï¼š å¾ˆé«˜å…´èƒ½ä¸ºæ‚¨æä¾›å¸®åŠ©ï¼ä½œä¸ºäº§å“ç»ç†ï¼Œæ‚¨å¯¹ç”µå•†APPçš„è¿­ä»£æœ‰ä»€ä¹ˆå…·ä½“æ–¹å‘æˆ–é—®é¢˜éœ€è¦æ¢è®¨å—ï¼Ÿæ¯”å¦‚ç”¨æˆ·å¢é•¿ã€åŠŸèƒ½ä¼˜åŒ–ã€ä½“éªŒæå‡ï¼Œæˆ–æ˜¯æ•°æ®é©±åŠ¨å†³ç­–ç­‰æ–¹é¢ï¼Ÿ

ç¬¬3è½® - åŠ©æ‰‹å›å¤ï¼š å¥½çš„ï¼Œå°æã€‚ä¼˜åŒ–ä¸‹å•æµç¨‹æ˜¯æå‡è½¬åŒ–ç‡å’Œç”¨æˆ·ä½“éªŒçš„å…³é”®ã€‚åŸºäºæˆ‘ä»¬ä¹‹å‰çš„è®¨è®ºï¼Œè¿™é‡Œæœ‰å‡ ä¸ªæ ¸å¿ƒæ–¹å‘å’Œå…·ä½“å»ºè®®ä¾›ä½ å‚è€ƒï¼š
...çœç•¥

ç¬¬4è½® - åŠ©æ‰‹å›å¤ï¼š æ ¹æ®å¯¹è¯æ‘˜è¦ï¼Œæ‚¨æ­£åœ¨ä¼˜åŒ–ç”µå•†APPçš„ä¸‹å•æµç¨‹ã€‚é’ˆå¯¹ç”¨æˆ·æµå¤±ç‡é«˜çš„é—®é¢˜ï¼Œå¯ä»¥ç»“åˆAIä¹‹å‰çš„å»ºè®®ï¼Œä»ä»¥ä¸‹å‡ ä¸ªæ–¹å‘å…¥æ‰‹ï¼š

...çœç•¥

æ‘˜è¦è®°å¿†çš„å®Œæ•´å¯¹è¯å†å²ï¼š
human: æˆ‘å«å°æï¼Œæ˜¯ä¸€åäº§å“ç»ç†
ai: ä½ å¥½å°æï¼å¾ˆé«˜å…´è®¤è¯†ä½ ï¼ä½œä¸ºäº§å“ç»ç†ï¼Œä½ çš„å·¥ä½œä¸€å®šå……æ»¡æŒ‘æˆ˜å’Œåˆ›æ„å§ï¼Ÿå¦‚æœéœ€è¦è®¨è®ºäº§å“è®¾è®¡ã€ç”¨æˆ·éœ€æ±‚æˆ–ä»»ä½•ç›¸å…³è¯é¢˜ï¼Œæˆ‘éšæ—¶å¯ä»¥å¸®å¿™å“¦ï¼ ğŸ˜Š
human: æˆ‘è´Ÿè´£ä¸€æ¬¾ç”µå•†APPçš„è¿­ä»£
ai: å¾ˆé«˜å…´èƒ½ä¸ºæ‚¨æä¾›å¸®åŠ©ï¼ä½œä¸ºäº§å“ç»ç†ï¼Œæ‚¨å¯¹ç”µå•†APPçš„è¿­ä»£æœ‰ä»€ä¹ˆå…·ä½“æ–¹å‘æˆ–é—®é¢˜éœ€è¦æ¢è®¨å—ï¼Ÿæ¯”å¦‚ç”¨æˆ·å¢é•¿ã€åŠŸèƒ½ä¼˜åŒ–ã€ä½“éªŒæå‡ï¼Œæˆ–æ˜¯æ•°æ®é©±åŠ¨å†³ç­–ç­‰æ–¹é¢ï¼Ÿ
human: æœ€è¿‘åœ¨ä¼˜åŒ–ç”¨æˆ·ä¸‹å•æµç¨‹
ai: å¥½çš„ï¼Œå°æã€‚ä¼˜åŒ–ä¸‹å•æµç¨‹æ˜¯æå‡è½¬åŒ–ç‡å’Œç”¨æˆ·ä½“éªŒçš„å…³é”®ã€‚åŸºäºæˆ‘ä»¬ä¹‹å‰çš„è®¨è®ºï¼Œè¿™é‡Œæœ‰å‡ ä¸ªæ ¸å¿ƒæ–¹å‘å’Œå…·ä½“å»ºè®®ä¾›ä½ å‚è€ƒï¼š
...çœç•¥

éœ€è¦è¿›ä¸€æ­¥è®¨è®ºå…·ä½“åŠŸèƒ½æˆ–æ•°æ®æŒ‡æ ‡å—ï¼Ÿ

æœ€ç»ˆå¯¹è¯æ‘˜è¦ï¼šå°ææ˜¯ç”µå•†APPäº§å“ç»ç†ï¼Œæ­£ä¼˜åŒ–ä¸‹å•æµç¨‹ä»¥è§£å†³ç”¨æˆ·æµå¤±ç‡é«˜çš„é—®é¢˜ï¼Œéœ€è¦å…·ä½“ä¼˜åŒ–å»ºè®®ã€‚
```

ä»”ç»†è§‚å¯Ÿå‘ç°ï¼Œè®°å¿†é‡Œä¸æ˜¯é€å­—é€å¥çš„å¯¹è¯åŸæ–‡ï¼Œè€Œæ˜¯ä¸€æ®µæ€»ç»“ã€‚è¿™æ ·å³ä½¿å¯¹è¯å¾ˆå¤šï¼Œæ‘˜è¦ä¹Ÿä¸ä¼šå¤ªé•¿ï¼Œéå¸¸é€‚åˆè¶…é•¿å¯¹è¯åœºæ™¯ã€‚

> ä¼˜åŒ–æç¤ºï¼šç”Ÿæˆæ‘˜è¦ä¼šé¢å¤–æ¶ˆè€— LLM ç®—åŠ›ï¼Œç”Ÿäº§ç¯å¢ƒå¯ç¼“å­˜æ‘˜è¦ï¼ˆæ¯”å¦‚æ¯ 5 è½®æ›´æ–°ä¸€æ¬¡ï¼‰ï¼Œå‡å°‘è°ƒç”¨æ¬¡æ•°ã€‚

#### 3.1.2.4 ä¸‰ç§Memoryæ€ä¹ˆé€‰ï¼Ÿ

å­¦å®Œä¸‰ç§æ¨¡å¼åï¼Œå¤§å®¶å¯èƒ½ä¼šçº ç»“â€œè¯¥ç”¨å“ªä¸ªï¼Ÿâ€ï¼Œè¿™é‡Œæ•´ç†äº†ä¸€å¼ å¯¹æ¯”è¡¨ï¼Œä¸€çœ‹å°±æ‡‚ï¼š

| è®°å¿†æ¨¡å¼ | æ ¸å¿ƒä¼˜åŠ¿                                | å±€é™æ€§                                    | é€‚ç”¨åœºæ™¯                                                 |
| :------- | :-------------------------------------- | :---------------------------------------- | :------------------------------------------------------- |
| å…¨é‡è®°å¿† | ä¸Šä¸‹æ–‡å®Œæ•´ï¼Œæ— ä¿¡æ¯ä¸¢å¤±ï¼Œå®ç°ç®€å•        | Tokenæ¶ˆè€—éšè½®æ•°çº¿æ€§å¢é•¿ï¼Œä¸é€‚ç”¨äºé•¿å¯¹è¯   | çŸ­å¯¹è¯ã€éœ€è¦å®Œæ•´ä¸Šä¸‹æ–‡çš„åœºæ™¯ï¼ˆå¦‚ä¸€å¯¹ä¸€å’¨è¯¢ï¼‰             |
| çª—å£è®°å¿† | Tokenæ¶ˆè€—å¯æ§ï¼Œæ€§èƒ½ç¨³å®šï¼Œå®ç°éš¾åº¦ä½     | å¯èƒ½ä¸¢å¤±æ—©æœŸå…³é”®ä¿¡æ¯ï¼Œä¸Šä¸‹æ–‡è¿è´¯æ€§æœ‰é™    | ä¸­é•¿å¯¹è¯ã€å¯¹æ—©æœŸä¿¡æ¯è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼ˆå¦‚é—²èŠï¼‰             |
| æ‘˜è¦è®°å¿† | Tokenæ¶ˆè€—ä½ï¼Œæ”¯æŒè¶…é•¿å¯¹è¯ï¼Œä¿ç•™æ ¸å¿ƒä¿¡æ¯ | é¢å¤–æ¶ˆè€—LLMç®—åŠ›ç”Ÿæˆæ‘˜è¦ï¼Œå¯èƒ½ä¸¢å¤±ç»†èŠ‚ä¿¡æ¯ | è¶…é•¿å¯¹è¯ã€éœ€è¦å¹³è¡¡ä¸Šä¸‹æ–‡ä¸æ•ˆç‡çš„åœºæ™¯ï¼ˆå¦‚å®¢æœã€é•¿æœŸåä½œï¼‰ |

#### 3.1.2.5 å·¥ç¨‹å»ºè®®

- **å­˜å‚¨ä¼˜åŒ–**ï¼šç¤ºä¾‹ä¸­ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼ˆInMemoryChatMessageHistoryï¼‰ï¼Œç”Ÿäº§ç¯å¢ƒéœ€æ›¿æ¢ä¸ºæŒä¹…åŒ–å­˜å‚¨ï¼ˆå¦‚Redisã€PostgreSQLã€MongoDBï¼‰ï¼ŒåŸºäº `BaseChatMessageHistory` å®ç°è‡ªå®šä¹‰å­˜å‚¨ç±»ã€‚
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‘˜è¦è®°å¿†å¯ç¼“å­˜æ‘˜è¦ç»“æœï¼Œé¿å…æ¯æ¬¡è°ƒç”¨éƒ½é‡æ–°ç”Ÿæˆï¼›çª—å£è®°å¿†å¯é¢„è®¡ç®—å†å²æ¶ˆæ¯é•¿åº¦ï¼Œç²¾å‡†æ§åˆ¶Tokenä¸Šé™ã€‚
- **å¤šæ¨¡å‹é€‚é…**ï¼šå¯æ›¿æ¢LLMä¸ºå¼€æºæ¨¡å‹ï¼ˆå¦‚Llama 3ã€Mistralï¼‰ï¼Œé™ä½APIè°ƒç”¨æˆæœ¬ã€‚
- **é”™è¯¯å¤„ç†**ï¼šæ·»åŠ ä¼šè¯å†å²æ¸…ç†ã€å¼‚å¸¸é‡è¯•ã€Tokenæº¢å‡ºæ£€æµ‹ç­‰é€»è¾‘ï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§ã€‚

#### 3.1.2.6 æ·±å…¥ç†è§£ï¼šè®°å¿†æ˜¯æ€ä¹ˆæ³¨å…¥åˆ°å¯¹è¯é‡Œçš„ï¼Ÿ

å¯èƒ½æœ‰åŒå­¦ä¼šå¥½å¥‡ï¼šâ€œè®°å¿†åˆ°åº•æ˜¯æ€ä¹ˆè¢«åŠ åˆ°å¯¹è¯é‡Œçš„ï¼Ÿâ€ 

æ ¸å¿ƒé“¾è·¯å…¶å®å¾ˆç®€å•ï¼š`ç”¨æˆ·æ–°é—®é¢˜ â†’ è®°å¿†ç»„ä»¶æå–å†å²å¯¹è¯ â†’ æŠŠâ€œå†å²+æ–°é—®é¢˜â€æ‹¼èµ·æ¥ â†’ å‘ç»™LLM â†’ LLMç”Ÿæˆå›å¤ â†’ æŠŠâ€œæ–°é—®é¢˜+å›å¤â€å­˜åˆ°è®°å¿†é‡Œ â†’ è¾“å‡ºç»“æœ`

è¦å®ç°è¿™ä¸ªé“¾è·¯ï¼Œéœ€è¦ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶é…åˆï¼š

1. ChatMessageHistoryï¼šç›¸å½“äºâ€œè®°å¿†ç¬”è®°æœ¬â€ï¼Œè´Ÿè´£å…·ä½“çš„å­˜å’Œå–æ“ä½œï¼›
2. RunnableWithMessageHistoryï¼šç›¸å½“äºâ€œè®°å¿†è°ƒåº¦å‘˜â€ï¼Œè´Ÿè´£åè°ƒæ•´ä¸ªæµç¨‹â€”â€”åœ¨è°ƒç”¨LLMå‰è‡ªåŠ¨å–å†å²ï¼Œè°ƒç”¨åè‡ªåŠ¨å­˜æ–°å¯¹è¯ã€‚

çŸ¥é“äº†åŸç†ï¼Œå¯ä»¥è‡ªå·±åŠ¨æ‰‹å®è·µï¼Œä¸å€ŸåŠ©langchainçš„æ¡†æ¶ï¼Œè‡ªå·±å®ç°å…¨é‡è®°å¿†

æ‰‹åŠ¨å®ç°å…¨é‡è®°å¿†demoç‰ˆï¼ˆä¾›å‚è€ƒï¼‰

```python
# æ‰‹åŠ¨å®ç°å…¨é‡è®°å¿†ï¼ˆæ— LangChainæ¡†æ¶ï¼Œç†è§£æ ¸å¿ƒé€»è¾‘ï¼‰
chat_history = []  # å­˜å‚¨å¯¹è¯å†å²çš„åˆ—è¡¨

def chat_with_memory(user_input):
    # 1. æ‹¼æ¥å†å²+æ–°é—®é¢˜
    prompt = "ä½ æ˜¯å‹å¥½çš„åŠ©æ‰‹ï¼Œç»“åˆå†å²å¯¹è¯å›ç­”ï¼š\n"
    for msg in chat_history:
        prompt += f"{msg['role']}: {msg['content']}\n"
    prompt += f"ç”¨æˆ·ï¼š{user_input}"
    
    # 2. è°ƒç”¨LLM
    response = llm.invoke(prompt).content
    
    # 3. ä¿å­˜æ–°å¯¹è¯åˆ°å†å²
    chat_history.append({"role": "ç”¨æˆ·", "content": user_input})
    chat_history.append({"role": "AI", "content": response})
    
    return response

# æµ‹è¯•
print(chat_with_memory("æˆ‘å«å°æ˜"))
print(chat_with_memory("æˆ‘åˆšæ‰å«ä»€ä¹ˆåå­—ï¼Ÿ"))
```

## 3.2å¤–éƒ¨è¡ŒåŠ¨å±‚ï¼ˆToolï¼‰ï¼šè®©AIèƒ½â€œåŠ¨æ‰‹â€è§£å†³é—®é¢˜

å­¦å®Œè®°å¿†ç»„ä»¶ï¼ŒAIå·²ç»èƒ½è®°ä½æˆ‘ä»¬è¯´çš„è¯äº†ï¼Œä½†è¿˜æœ‰ä¸€ä¸ªå±€é™ï¼šå®ƒçš„çŸ¥è¯†åªåœç•™åœ¨è®­ç»ƒæ•°æ®é‡Œï¼Œæ²¡æ³•è·å–å®æ—¶ä¿¡æ¯ï¼ˆæ¯”å¦‚ä»Šå¤©çš„å¤©æ°”ï¼‰ã€æ“ä½œç”µè„‘æ–‡ä»¶ï¼Œä¹Ÿæ²¡æ³•è°ƒç”¨å…¶ä»–APIã€‚è€ŒToolç»„ä»¶ï¼Œå°±æ˜¯ç»™AIè£…ä¸Šâ€œæ‰‹å’Œè„šâ€ï¼Œè®©å®ƒèƒ½è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼Œè§£å†³è¿™äº›åŸç”Ÿèƒ½åŠ›è§£å†³ä¸äº†çš„é—®é¢˜ã€‚

### 3.2.1 å…ˆææ‡‚ï¼šå·¥å…·è°ƒç”¨çš„æ ¸å¿ƒé€»è¾‘

ç®€å•è¯´ï¼Œå·¥å…·è°ƒç”¨å°±æ˜¯è®©AIå­¦ä¼šâ€œæ€è€ƒâ†’è¡ŒåŠ¨â†’åé¦ˆâ€çš„å¾ªç¯ã€‚æ¯”å¦‚æˆ‘ä»¬é—®â€œä»Šå¤©åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿâ€ï¼ŒAIä¼šè¿™æ ·åšï¼š

1. æ€è€ƒï¼šâ€œè¿™ä¸ªé—®é¢˜æˆ‘æ²¡æ³•ç›´æ¥å›ç­”ï¼Œéœ€è¦è°ƒç”¨å¤©æ°”å·¥å…·æŸ¥è¯¢â€ï¼›
2. è¡ŒåŠ¨ï¼šç”Ÿæˆå·¥å…·è°ƒç”¨æŒ‡ä»¤ï¼ˆæ¯”å¦‚â€œè°ƒç”¨WeatherQueryå·¥å…·ï¼Œå‚æ•°æ˜¯åŒ—äº¬â€ï¼‰ï¼›
3. åé¦ˆï¼šå·¥å…·è¿”å›æŸ¥è¯¢ç»“æœï¼ˆæ¯”å¦‚â€œåŒ—äº¬ä»Šå¤©20â„ƒï¼Œæ™´â€ï¼‰ï¼ŒAIç»“åˆè¿™ä¸ªç»“æœç”Ÿæˆæœ€ç»ˆå›ç­”ã€‚

#### 3.2.1.1 ä¸‰ä¸ªå…³é”®ç»„ä»¶

è¦å®ç°å·¥å…·è°ƒç”¨ï¼Œéœ€è¦ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶é…åˆï¼Œå°±åƒä¸€ä¸ªå›¢é˜Ÿï¼š

- Toolï¼ˆå·¥å…·ï¼‰ï¼šå…·ä½“çš„â€œå¹²æ´»å·¥å…·â€ï¼Œæ¯”å¦‚æŸ¥è¯¢å¤©æ°”çš„å·¥å…·ã€è¯»æ–‡ä»¶çš„å·¥å…·ã€‚æ¯ä¸ªå·¥å…·éƒ½æœ‰æ˜ç¡®çš„åç§°å’Œæè¿°ï¼ˆAIå°±æ˜¯é€šè¿‡æè¿°çŸ¥é“è¯¥ç”¨å“ªä¸ªå·¥å…·çš„ï¼‰ï¼›
- Toolkitï¼ˆå·¥å…·åŒ…ï¼‰ï¼šæŠŠç›¸å…³çš„å·¥å…·æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œæ¯”å¦‚â€œæ–‡ä»¶æ“ä½œå·¥å…·åŒ…â€é‡ŒåŒ…å«è¯»æ–‡ä»¶ã€å†™æ–‡ä»¶ã€åˆ—ç›®å½•ä¸‰ä¸ªå·¥å…·ï¼›
- Agentï¼ˆæ™ºèƒ½ä½“ï¼‰ï¼šå›¢é˜Ÿçš„â€œæŒ‡æŒ¥å®˜â€ï¼Œè´Ÿè´£åè°ƒLLMå’Œå·¥å…·â€”â€”åˆ¤æ–­è¦ä¸è¦è°ƒç”¨å·¥å…·ã€ç”¨å“ªä¸ªå·¥å…·ã€æ€ä¹ˆå¤„ç†å·¥å…·è¿”å›çš„ç»“æœã€‚

#### 3.2.1.2 å­¦ä¹ æ¡ˆä¾‹ï¼šæŸ¥å¤©æ°”

> ä¸€èˆ¬æ¥è¯´ï¼Œåº”è¯¥æ˜¯ä½¿ç”¨è¯·æ±‚apiè·å¾—å®æ—¶çš„å¤©æ°”æƒ…å†µï¼Œä½†è€ƒè™‘åˆ°è¿™ç±»apiä¸€èˆ¬æ˜¯è¦æ”¶è´¹çš„ï¼Œä¸ºäº†å­¦ä¹ æ–¹ä¾¿ï¼Œè¿™é‡Œæ¡ˆä¾‹è°ƒæ•´ä¸ºå›ºå®šå‡½æ•°çš„å½¢å¼

```python
from langchain.agents import create_openai_tools_agent, AgentExecutor
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.tools import tool  # å¯¼å…¥è‡ªå®šä¹‰å·¥å…·çš„è£…é¥°å™¨
from langchain_openai import ChatOpenAI  # è¡¥å……LLMçš„å¯¼å…¥
import os
from dotenv import load_dotenv

load_dotenv()
API_KEY = os.getenv("API_KEY")
BASE_URL = "https://api.deepseek.com"

# åˆå§‹åŒ–LLMæ¨¡å‹
llm = ChatOpenAI(
    api_key=API_KEY,
    base_url=BASE_URL,
    model="deepseek-chat",
    temperature=0.3  # é™ä½éšæœºæ€§ï¼Œä¿è¯è¾“å‡ºç¨³å®š
)

# 1. è‡ªå®šä¹‰å¤©æ°”æŸ¥è¯¢å·¥å…·ï¼ˆå¦‚æœ‰æ¡ä»¶å¯ä½¿ç”¨å¤–éƒ¨apiï¼‰
# ä½¿ç”¨@toolè£…é¥°å™¨æ˜¯LangChainå®šä¹‰è‡ªå®šä¹‰å·¥å…·çš„æ ‡å‡†æ–¹å¼
@tool
def weather_query(city: str) -> str:
    """
    ç”¨äºæŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å®æ—¶å¤©æ°”ã€æ¸©åº¦ã€é™æ°´æ¦‚ç‡ç­‰ä¿¡æ¯ï¼ˆæ•™å­¦æ¼”ç¤ºç”¨ï¼Œè¿”å›å›ºå®šæ•°æ®ï¼‰
    å‚æ•°ï¼š
        city: è¦æŸ¥è¯¢çš„åŸå¸‚åç§°ï¼ˆå­—ç¬¦ä¸²ï¼‰
    è¿”å›ï¼š
        è¯¥åŸå¸‚çš„æ¨¡æ‹Ÿå¤©æ°”ä¿¡æ¯
    """
    # æ¨¡æ‹Ÿå›ºå®šçš„å¤©æ°”æ•°æ®
    weather_data = {
        "åŒ—äº¬": "åŒ—äº¬ä»Šæ—¥å¤©æ°”ï¼šæ™´ï¼Œæ¸©åº¦-2~8â„ƒï¼ŒåŒ—é£2çº§ï¼Œé™æ°´æ¦‚ç‡0%ï¼Œç©ºæ°”è´¨é‡ä¼˜",
        "ä¸Šæµ·": "ä¸Šæµ·ä»Šæ—¥å¤©æ°”ï¼šå¤šäº‘ï¼Œæ¸©åº¦5~12â„ƒï¼Œä¸œé£1çº§ï¼Œé™æ°´æ¦‚ç‡10%ï¼Œç©ºæ°”è´¨é‡è‰¯",
        "å¹¿å·": "å¹¿å·ä»Šæ—¥å¤©æ°”ï¼šé˜´è½¬å°é›¨ï¼Œæ¸©åº¦18~25â„ƒï¼Œå—é£3çº§ï¼Œé™æ°´æ¦‚ç‡60%ï¼Œç©ºæ°”è´¨é‡è‰¯",
        "æ·±åœ³": "æ·±åœ³ä»Šæ—¥å¤©æ°”ï¼šé›·é˜µé›¨ï¼Œæ¸©åº¦20~28â„ƒï¼Œä¸œå—é£4çº§ï¼Œé™æ°´æ¦‚ç‡80%ï¼Œç©ºæ°”è´¨é‡ä¼˜",
    }
    # å¦‚æœæŸ¥è¯¢çš„åŸå¸‚ä¸åœ¨é¢„è®¾åˆ—è¡¨ä¸­ï¼Œè¿”å›é»˜è®¤æç¤º
    return weather_data.get(city, f"æš‚æœªæŸ¥è¯¢åˆ°{city}çš„å¤©æ°”æ•°æ®ï¼ˆæ•™å­¦æ¼”ç¤ºç‰ˆï¼‰")

# æŠŠè‡ªå®šä¹‰å·¥å…·æ”¾åˆ°åˆ—è¡¨é‡Œ
tools = [weather_query]

# 3. å®šä¹‰Agentçš„æç¤ºæ¨¡æ¿
prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€åä¿¡æ¯æŸ¥è¯¢åŠ©æ‰‹ï¼Œåªèƒ½ä½¿ç”¨æä¾›çš„å·¥å…·æŸ¥è¯¢ä¿¡æ¯ã€‚å¦‚æœä¸éœ€è¦å·¥å…·ï¼Œç›´æ¥å›ç­”ã€‚"),
    ("user", "{input}"),
    ("assistant", "{agent_scratchpad}")  # ç•™ç»™AIè®°å½•æ€è€ƒå’Œå·¥å…·è°ƒç”¨è¿‡ç¨‹çš„åœ°æ–¹
])

# 4. æ„å»ºAgentå’Œæ‰§è¡Œå™¨
agent = create_openai_tools_agent(llm, tools, prompt)
# verbose=Trueï¼šæ˜¾ç¤ºè¯¦ç»†çš„æ€è€ƒå’Œæ‰§è¡Œè¿‡ç¨‹ï¼Œé€‚åˆå­¦ä¹ æ¼”ç¤º
agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=True)

# 5. æ‰§è¡ŒæŸ¥è¯¢ï¼ˆæµ‹è¯•ä¸åŒåŸå¸‚ï¼‰
if __name__ == "__main__":
    # æµ‹è¯•1ï¼šæŸ¥è¯¢é¢„è®¾åŸå¸‚ï¼ˆåŒ—äº¬ï¼‰
    result1 = agent_executor.invoke({"input": "æŸ¥è¯¢åŒ—äº¬ä»Šå¤©çš„å®æ—¶å¤©æ°”"})
    print(f"\næœ€ç»ˆç»“æœ1ï¼š{result1['output']}\n")
    
    # æµ‹è¯•2ï¼šæŸ¥è¯¢å¦ä¸€ä¸ªé¢„è®¾åŸå¸‚ï¼ˆä¸Šæµ·ï¼‰
    result2 = agent_executor.invoke({"input": "ä¸Šæµ·ä»Šå¤©æ¸©åº¦å¤šå°‘ï¼Ÿ"})
    print(f"æœ€ç»ˆç»“æœ2ï¼š{result2['output']}\n")
    
    # æµ‹è¯•3ï¼šæŸ¥è¯¢æœªé¢„è®¾çš„åŸå¸‚ï¼ˆæˆéƒ½ï¼‰
    result3 = agent_executor.invoke({"input": "æˆéƒ½ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"})
    print(f"æœ€ç»ˆç»“æœ3ï¼š{result3['output']}")
```

è¿è¡Œç»“æœ

```
> Entering new AgentExecutor chain...

Invoking: `weather_query` with `{'city': 'åŒ—äº¬'}`
responded: æˆ‘æ¥å¸®æ‚¨æŸ¥è¯¢åŒ—äº¬ä»Šå¤©çš„å®æ—¶å¤©æ°”ã€‚

åŒ—äº¬ä»Šæ—¥å¤©æ°”ï¼šæ™´ï¼Œæ¸©åº¦-2~8â„ƒï¼ŒåŒ—é£2çº§ï¼Œé™æ°´æ¦‚ç‡0%ï¼Œç©ºæ°”è´¨é‡ä¼˜æ ¹æ®æŸ¥è¯¢ç»“æœï¼ŒåŒ—äº¬ä»Šå¤©çš„å®æ—¶å¤©æ°”æƒ…å†µå¦‚ä¸‹ï¼š

- **å¤©æ°”çŠ¶å†µ**ï¼šæ™´
- **æ¸©åº¦**ï¼š-2â„ƒ ~ 8â„ƒ
- **é£åŠ›**ï¼šåŒ—é£2çº§
- **é™æ°´æ¦‚ç‡**ï¼š0%
- **ç©ºæ°”è´¨é‡**ï¼šä¼˜

ä»Šå¤©åŒ—äº¬å¤©æ°”æ™´æœ—ï¼Œæ°”æ¸©åœ¨é›¶ä¸‹2åº¦åˆ°8åº¦ä¹‹é—´ï¼Œæ²¡æœ‰é™æ°´ï¼Œç©ºæ°”è´¨é‡å¾ˆå¥½ï¼Œæ˜¯ä¸ªä¸é”™çš„å¤©æ°”ï¼

> Finished chain.

æœ€ç»ˆç»“æœ1ï¼šæ ¹æ®æŸ¥è¯¢ç»“æœï¼ŒåŒ—äº¬ä»Šå¤©çš„å®æ—¶å¤©æ°”æƒ…å†µå¦‚ä¸‹ï¼š

- **å¤©æ°”çŠ¶å†µ**ï¼šæ™´
- **æ¸©åº¦**ï¼š-2â„ƒ ~ 8â„ƒ
- **é£åŠ›**ï¼šåŒ—é£2çº§
- **é™æ°´æ¦‚ç‡**ï¼š0%
- **ç©ºæ°”è´¨é‡**ï¼šä¼˜

ä»Šå¤©åŒ—äº¬å¤©æ°”æ™´æœ—ï¼Œæ°”æ¸©åœ¨é›¶ä¸‹2åº¦åˆ°8åº¦ä¹‹é—´ï¼Œæ²¡æœ‰é™æ°´ï¼Œç©ºæ°”è´¨é‡å¾ˆå¥½ï¼Œæ˜¯ä¸ªä¸é”™çš„å¤©æ°”ï¼
```

é€šè¿‡è¿è¡Œç»“æœå¯ä»¥çœ‹åˆ° AI çš„å®Œæ•´æ€è€ƒè¿‡ç¨‹ï¼šåˆ¤æ–­éœ€è¦è°ƒç”¨ WeatherQuery å·¥å…· â†’ ä¼ å…¥å‚æ•° â€œåŒ—äº¬â€ â†’ å·¥å…·è¿”å›ç»“æœ â†’ AI æ•´ç†æˆè‡ªç„¶è¯­è¨€å›ç­”ï¼Œè¿™å°±æ˜¯å·¥å…·è°ƒç”¨çš„å®Œæ•´æµç¨‹ã€‚

è¿™å°±æ˜¯å·¥å…·è°ƒç”¨çš„å®Œæ•´æµç¨‹å•¦ï¼

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å…¶å®å°±æ˜ç™½ï¼Œå¤§æ¨¡å‹è°ƒç”¨å·¥å…·ï¼Œæœ¬è´¨æ˜¯æ€è€ƒâ†’è¡ŒåŠ¨â†’åé¦ˆï¼Œåœ¨å›ç­”è¿‡ç¨‹ä¸­è°ƒç”¨å·¥å…·è·å¾—ç»“æœåå†è¿”å›ã€‚

### 3.2.2 é«˜çº§æŠ€å·§ï¼šè‡ªå®šä¹‰å·¥å…·ï¼ˆ@toolè£…é¥°å™¨ï¼‰

é€šè¿‡å‰é¢çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å‘ç°LangChainæä¾›äº†@toolè£…é¥°å™¨ï¼Œè¿™æ ·å¯ä»¥è®©æˆ‘ä»¬èƒ½å¿«é€Ÿåˆ›å»ºè‡ªå·±çš„å·¥å…·ï¼Œéå¸¸æ–¹ä¾¿ã€‚

#### 3.2.2.1 è‡ªå®šä¹‰å·¥å…·çš„æ ¸å¿ƒè¦æ±‚

è¦è®©AIèƒ½æ­£ç¡®ä½¿ç”¨ä½ çš„å·¥å…·ï¼Œå¿…é¡»æ»¡è¶³ä¸‰ä¸ªè¦æ±‚ï¼š

- å†™æ¸…æ¥šæ–‡æ¡£å­—ç¬¦ä¸²ï¼ˆdocstringï¼‰ï¼šå‘Šè¯‰AIè¿™ä¸ªå·¥å…·èƒ½åšä»€ä¹ˆã€éœ€è¦ä»€ä¹ˆå‚æ•°ï¼›
- æ˜ç¡®å‚æ•°ç±»å‹ï¼šç”¨ç±»å‹æ³¨è§£ï¼ˆæ¯”å¦‚intã€strï¼‰æŒ‡å®šå‚æ•°ç±»å‹ï¼ŒAIæ‰çŸ¥é“è¯¥ä¼ ä»€ä¹ˆç±»å‹çš„å€¼ï¼›
- è¿”å›ç»“æœæ¸…æ™°ï¼šå·¥å…·æ‰§è¡Œåçš„è¿”å›å€¼è¦ç®€æ´æ˜äº†ï¼Œæ–¹ä¾¿AIæ•´ç†æˆå›ç­”ã€‚

#### 3.2.2.2 å­¦ä¹ æ¡ˆä¾‹:æ¸©åº¦å•ä½è½¬æ¢

```python
from langchain.agents import create_openai_tools_agent, AgentExecutor
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.tools import tool  # å¯¼å…¥è‡ªå®šä¹‰å·¥å…·çš„è£…é¥°å™¨
from langchain_openai import ChatOpenAI  # è¡¥å……LLMçš„å¯¼å…¥
from pydantic import BaseModel, Field
import os
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()
API_KEY = os.getenv("API_KEY")
BASE_URL = "https://api.deepseek.com"

# åˆå§‹åŒ–LLMæ¨¡å‹
llm = ChatOpenAI(
    api_key=API_KEY,
    base_url=BASE_URL,
    model="deepseek-chat",
    temperature=0.3  # é™ä½éšæœºæ€§ï¼Œä¿è¯è¾“å‡ºç¨³å®š
)

# 1. å®šä¹‰å‚æ•°æ¨¡å‹ï¼ˆç”¨äºå‚æ•°æ ¡éªŒå’Œæè¿°ï¼‰
class TemperatureConvertInput(BaseModel):
    temperature: float = Field(description="éœ€è¦è½¬æ¢çš„æ¸©åº¦å€¼ï¼Œä¾‹å¦‚37.0")
    from_unit: str = Field(description="åŸå§‹æ¸©åº¦å•ä½ï¼Œåªèƒ½æ˜¯'celsius'ï¼ˆæ‘„æ°åº¦ï¼‰æˆ–'fahrenheit'ï¼ˆåæ°åº¦ï¼‰")

# 2. è‡ªå®šä¹‰æ¸©åº¦è½¬æ¢å·¥å…·ï¼ˆä¿®å¤@toolè£…é¥°å™¨å‚æ•°é—®é¢˜ï¼‰
@tool(args_schema=TemperatureConvertInput)  # æ–°ç‰ˆä»…ä¿ç•™args_schemaå‚æ•°ï¼ˆå¦‚éœ€å‚æ•°æ ¡éªŒï¼‰
def temperature_converter(temperature: float, from_unit: str) -> str:
    """
    ç”¨äºæ¸©åº¦å•ä½è½¬æ¢çš„å·¥å…·ï¼Œæ”¯æŒæ‘„æ°åº¦ï¼ˆcelsiusï¼‰ä¸åæ°åº¦ï¼ˆfahrenheitï¼‰åŒå‘äº’è½¬ã€‚
    
    å‚æ•°è¯´æ˜ï¼š
        temperature: æ•°å€¼å‹æ¸©åº¦å€¼ï¼ˆå¦‚37.0ï¼‰
        from_unit: åŸå§‹å•ä½ï¼Œä»…æ”¯æŒ'celsius'æˆ–'fahrenheit'
    """
    # æ ¡éªŒå•ä½åˆæ³•æ€§
    if from_unit not in ["celsius", "fahrenheit"]:
        return f"é”™è¯¯ï¼šå•ä½'{from_unit}'ä¸åˆæ³•ï¼Œä»…æ”¯æŒ'celsius'ï¼ˆæ‘„æ°åº¦ï¼‰æˆ–'fahrenheit'ï¼ˆåæ°åº¦ï¼‰"
    
    # æ¸©åº¦è½¬æ¢é€»è¾‘
    if from_unit == "celsius":
        # æ‘„æ°åº¦è½¬åæ°åº¦ï¼šF = C * 9/5 + 32
        fahrenheit = temperature * 9/5 + 32
        return f"{temperature}æ‘„æ°åº¦ = {fahrenheit:.2f}åæ°åº¦"
    else:
        # åæ°åº¦è½¬æ‘„æ°åº¦ï¼šC = (F - 32) * 5/9
        celsius = (temperature - 32) * 5/9
        return f"{temperature}åæ°åº¦ = {celsius:.2f}æ‘„æ°åº¦"

# 3. é…ç½®Agentï¼ˆå…³é”®ï¼šPromptå¿…é¡»åŒ…å«MessagesPlaceholderç”¨äºagent_scratchpadï¼‰
tools = [temperature_converter]

# æ­£ç¡®çš„Promptæ¨¡æ¿
prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€åä¸“ä¸šçš„æ¸©åº¦è½¬æ¢åŠ©æ‰‹ï¼Œä»…ä½¿ç”¨æä¾›çš„TemperatureConverterå·¥å…·å®Œæˆè½¬æ¢ä»»åŠ¡ï¼Œä¸¥æ ¼æŒ‰ç…§å·¥å…·è¦æ±‚ä¼ å‚ã€‚"),
    ("human", "{input}"),
    MessagesPlaceholder(variable_name="agent_scratchpad"),  # å¿…é¡»ä¿ç•™ï¼Œç”¨äºAgentæ€è€ƒè¿‡ç¨‹
])

# æ„å»ºAgentå’Œæ‰§è¡Œå™¨
agent = create_openai_tools_agent(llm, tools, prompt)
agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=True)

# æ‰§è¡Œè½¬æ¢ä»»åŠ¡
if __name__ == "__main__":
    result = agent_executor.invoke({"input": "å°†37æ‘„æ°åº¦è½¬æ¢ä¸ºåæ°åº¦"})
    print(f"\næœ€ç»ˆç»“æœï¼š{result['output']}")
```

è¿è¡Œç»“æœ

```
> Entering new AgentExecutor chain...

Invoking: `temperature_converter` with `{'temperature': 37, 'from_unit': 'celsius'}`
responded: æˆ‘æ¥å¸®æ‚¨å°†37æ‘„æ°åº¦è½¬æ¢ä¸ºåæ°åº¦ã€‚

37.0æ‘„æ°åº¦ = 98.60åæ°åº¦37æ‘„æ°åº¦ç­‰äº98.60åæ°åº¦ã€‚

> Finished chain.

æœ€ç»ˆç»“æœï¼š37æ‘„æ°åº¦ç­‰äº98.60åæ°åº¦ã€‚
```

å¯ä»¥çœ‹åˆ°æ¨¡å‹æ­£ç¡®è°ƒç”¨@toolå·¥å…·ï¼Œç„¶åå¾—åˆ°äº†éœ€è¦çš„ç»“æœ

æˆ‘ä»¬æ¥çœ‹çœ‹@toolå·¥å…·çš„æºç 

```python
(function)
def tool(
    *,
    description: str | None = None,          # å·¥å…·åŠŸèƒ½æè¿°ï¼ˆAgentåˆ¤æ–­æ˜¯å¦è°ƒç”¨çš„æ ¸å¿ƒä¾æ®ï¼‰
    return_direct: bool = False,             # æ˜¯å¦ç›´æ¥è¿”å›å·¥å…·ç»“æœï¼ˆFalseï¼šLLMæ•´ç†åè¿”å›ï¼‰
    args_schema: ArgsSchema | None = None,   # å‚æ•°æ ¡éªŒæ¨¡å‹ï¼ˆPydantic BaseModelï¼‰
    infer_schema: bool = True,               # æ˜¯å¦è‡ªåŠ¨ä»ç±»å‹æ³¨è§£æ¨å¯¼å‚æ•°schema
    response_format: Literal['content', 'content_and_artifact'] = "content",  # è¿”å›æ ¼å¼
    parse_docstring: bool = False,           # æ˜¯å¦è§£ædocstringç”Ÿæˆæè¿°/å‚æ•°ä¿¡æ¯
    error_on_invalid_docstring: bool = True  # docstringè§£æå¤±è´¥æ—¶æ˜¯å¦æŠ›å¼‚å¸¸
)
```

åšä¸€ä¸ªç®€å•çš„ä»‹ç»

1. `description: str | None = None`

- **æ ¸å¿ƒä½œç”¨**ï¼šæ‰‹åŠ¨æŒ‡å®šå·¥å…·çš„åŠŸèƒ½æè¿°ï¼Œæ˜¯**Agent åˆ¤æ–­ â€œä½•æ—¶è°ƒç”¨è¯¥å·¥å…·â€ çš„æ ¸å¿ƒä¾æ®**ï¼ˆAgent ä¼šæŠŠç”¨æˆ·é—®é¢˜å’Œ description åŒ¹é…ï¼Œå†³å®šæ˜¯å¦è°ƒç”¨ï¼‰ã€‚
- **é»˜è®¤è¡Œä¸º**ï¼šè‹¥ä¸ä¼ ï¼Œä¼šä¼˜å…ˆé€šè¿‡`parse_docstring`ï¼ˆè§£æå‡½æ•° docstringï¼‰æˆ–å‡½æ•°åæ¨å¯¼ç®€å•æè¿°ã€‚

2. `return_direct: bool = False`

- æ ¸å¿ƒä½œç”¨ï¼šæ§åˆ¶å·¥å…·æ‰§è¡Œç»“æœçš„è¿”å›é€»è¾‘ï¼š
  - `False`ï¼ˆé»˜è®¤ï¼‰ï¼šå·¥å…·ç»“æœä¼šä¼ ç»™ LLMï¼Œç”± LLM æ•´ç†æˆè‡ªç„¶è¯­è¨€å›ç­”åè¿”å›ï¼›
  - `True`ï¼šè·³è¿‡ LLM äºŒæ¬¡å¤„ç†ï¼Œç›´æ¥è¿”å›å·¥å…·çš„åŸå§‹æ‰§è¡Œç»“æœã€‚


3.`args_schema: ArgsSchema | None = None`

- **æ ¸å¿ƒä½œç”¨**ï¼šé€šè¿‡ Pydantic `BaseModel`ï¼ˆ`ArgsSchema`æ˜¯å…¶åˆ«åï¼‰å®šä¹‰å‚æ•°çš„**ç±»å‹ã€æè¿°ã€æ ¡éªŒè§„åˆ™**ï¼ˆå¦‚å–å€¼èŒƒå›´ã€å¿…å¡«é¡¹ã€æšä¸¾å€¼ï¼‰ï¼Œå¼ºåˆ¶çº¦æŸ Agent ä¼ å‚çš„æ­£ç¡®æ€§ã€‚

4. `infer_schema: bool = True`

- æ ¸å¿ƒä½œç”¨ï¼šæ§åˆ¶æ˜¯å¦è‡ªåŠ¨ä»å‡½æ•°çš„ç±»å‹æ³¨è§£æ¨å¯¼å‚æ•° schemaï¼š

  - `True`ï¼ˆé»˜è®¤ï¼‰ï¼šè‡ªåŠ¨è§£æå‡½æ•°æ³¨è§£ï¼Œç”ŸæˆåŸºç¡€çš„å‚æ•°ç±»å‹æ ¡éªŒï¼›
  - `False`ï¼šç¦ç”¨è‡ªåŠ¨æ¨å¯¼ï¼Œä»…ä½¿ç”¨`args_schema`ï¼ˆè‹¥ä¼ ï¼‰æˆ–æ— å‚æ•°æ ¡éªŒã€‚

5. `response_format: Literal['content', 'content_and_artifact'] = "content"`

  - æ ¸å¿ƒä½œç”¨ï¼šæ§åˆ¶å·¥å…·è¿”å›ç»“æœçš„æ ¼å¼ï¼š

    - `"content"`ï¼ˆé»˜è®¤ï¼‰ï¼šä»…è¿”å›å·¥å…·å‡½æ•°çš„è¿”å›å€¼ï¼ˆå¦‚å­—ç¬¦ä¸²ã€æ•°å€¼ï¼‰ï¼Œç®€æ´é«˜æ•ˆï¼›
- `"content_and_artifact"`ï¼šè¿”å›å­—å…¸`{"content": å·¥å…·ç»“æœ, "artifact": å…ƒä¿¡æ¯}`ï¼Œå¯æºå¸¦æ‰§è¡Œè€—æ—¶ã€è¯·æ±‚ ID ç­‰é¢å¤–æ•°æ®ã€‚

6. `parse_docstring: bool = False`

- æ ¸å¿ƒä½œç”¨ï¼šæ§åˆ¶æ˜¯å¦è§£æå‡½æ•°çš„docstringï¼Œæ¥è‡ªåŠ¨æ¨å¯¼`description`ï¼ˆå·¥å…·æè¿°ï¼‰å’Œå‚æ•°ä¿¡æ¯ï¼š

  - `True`ï¼šä¼˜å…ˆä» docstring æå–å·¥å…·æè¿°ã€å‚æ•°è¯´æ˜ï¼Œæ›¿ä»£æ‰‹åŠ¨ä¼ `description`/`args_schema`ï¼›
  - `False`ï¼ˆé»˜è®¤ï¼‰ï¼šå¿½ç•¥ docstringï¼Œä»…ä½¿ç”¨æ‰‹åŠ¨ä¼ çš„å‚æ•°æˆ–è‡ªåŠ¨æ³¨è§£æ¨å¯¼ã€‚

7. `error_on_invalid_docstring: bool = True`

  - æ ¸å¿ƒä½œç”¨ï¼šå½“`parse_docstring=True`ä½† docstring æ ¼å¼ä¸åˆæ³•ï¼ˆå¦‚å‚æ•°æè¿°ç¼ºå¤±ã€æ ¼å¼æ··ä¹±ï¼‰æ—¶ï¼Œæ§åˆ¶ç¨‹åºè¡Œä¸ºï¼š
    - `True`ï¼ˆé»˜è®¤ï¼‰ï¼šæŠ›å‡ºå¼‚å¸¸ï¼Œç»ˆæ­¢å·¥å…·åˆ›å»ºï¼›
    - `False`ï¼šå¿½ç•¥è§£æé”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤çš„å·¥å…·æè¿° / å‚æ•°è§„åˆ™ã€‚

### 3.2.3 å…¶ä»–å¸¸ç”¨å†…ç½®å·¥å…·

é™¤äº†è‡ªå®šä¹‰å·¥å…·æ„å¤–ï¼ŒLangChainè¿˜æœ‰å¾ˆå¤šå†…ç½®å·¥å…·ï¼Œä¸ç”¨å¤§å®¶é‡æ–°å»è®¾è®¡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œéå¸¸æ–¹ä¾¿ã€‚

**ä¾‹å¦‚æ–‡ä»¶æ“ä½œç±»å·¥å…·**

- ReadFileToolï¼šè¯»å–æœ¬åœ°æ–‡ä»¶çš„å†…å®¹ï¼ˆæ¯”å¦‚è¯»å–txtã€docxæ–‡ä»¶ï¼‰ï¼›
- WriteFileToolï¼šæŠŠå†…å®¹å†™å…¥æœ¬åœ°æ–‡ä»¶ï¼ˆæ¯”å¦‚ç”ŸæˆæŠ¥å‘Šåä¿å­˜åˆ°ç”µè„‘ï¼‰ï¼›
- ListDirectoryToolï¼šæŸ¥çœ‹æŒ‡å®šæ–‡ä»¶å¤¹é‡Œæœ‰å“ªäº›æ–‡ä»¶ã€‚

> è¿è¡Œæ³¨æ„äº‹é¡¹ï¼šæ³¨æ„æ–‡ä»¶è·¯å¾„æƒé™ï¼ŒWindows è·¯å¾„ç”¨`\\`æˆ–`/`ï¼Œé¿å…æƒé™ä¸è¶³å¯¼è‡´æ“ä½œå¤±è´¥ã€‚

#### 3.2.3.1 å­¦ä¹ æ¡ˆä¾‹ï¼šåˆ›å»ºæ–‡ä»¶

```python
from langchain.agents import create_openai_tools_agent, AgentExecutor
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.tools import tool  # å¯¼å…¥è‡ªå®šä¹‰å·¥å…·çš„è£…é¥°å™¨
from langchain_openai import ChatOpenAI  # è¡¥å……LLMçš„å¯¼å…¥
from pydantic import BaseModel, Field
import os
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()
API_KEY = os.getenv("API_KEY")
BASE_URL = "https://api.deepseek.com"

# åˆå§‹åŒ–LLMæ¨¡å‹
llm = ChatOpenAI(
    api_key=API_KEY,
    base_url=BASE_URL,
    model="deepseek-chat",
    temperature=0.3  # é™ä½éšæœºæ€§ï¼Œä¿è¯è¾“å‡ºç¨³å®š
)

# 1. å¯¼å…¥LangChainå†…ç½®çš„æ–‡ä»¶å†™å…¥å·¥å…·
from langchain.tools.file_management.write import WriteFileTool

# 2. å®šä¹‰è¦ä½¿ç”¨çš„å·¥å…·åˆ—è¡¨ï¼ˆæ­¤å¤„ä½¿ç”¨WriteFileToolï¼‰
tools = [WriteFileTool()]

# 3. æ„å»ºPromptæ¨¡æ¿ï¼Œæ˜ç¡®å‘ŠçŸ¥Agentä»»åŠ¡ï¼šåˆ›å»ºllmè¯—è¯.txtå¹¶å†™å…¥ä¸€é¦–è¯—
prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€ä¸ªæ“…é•¿ä½¿ç”¨å·¥å…·å®Œæˆæ–‡ä»¶æ“ä½œçš„åŠ©æ‰‹ï¼Œä¸¥æ ¼æŒ‰ç…§å·¥å…·è¦æ±‚æ‰§è¡Œä»»åŠ¡ã€‚"),
    ("user", "è¯·ä½ åˆ›å»ºä¸€ä¸ªåä¸ºllmè¯—è¯.txtçš„æ–‡ä»¶ï¼Œå¹¶åœ¨æ–‡ä»¶ä¸­å†™å…¥ä¸€é¦–åŸåˆ›çš„ä¸ƒè¨€ç»å¥ï¼Œä¸»é¢˜å›´ç»•ç§‘æŠ€ä¸äººæ–‡çš„èåˆã€‚"),
    MessagesPlaceholder(variable_name="agent_scratchpad"),  # ç”¨äºAgentè®°å½•æ€è€ƒè¿‡ç¨‹
])

# 4. åˆ›å»ºAgentï¼ˆå°†LLMã€Promptã€å·¥å…·ç»‘å®šï¼‰
agent = create_openai_tools_agent(llm, tools, prompt)

# 5. åˆ›å»ºAgentæ‰§è¡Œå™¨ï¼ˆè´Ÿè´£è°ƒåº¦Agentæ‰§è¡Œä»»åŠ¡ï¼‰
agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=True)

# 6. è¿è¡ŒAgentï¼Œæ‰§è¡Œåˆ›å»ºæ–‡ä»¶å¹¶å†™å…¥è¯—è¯çš„ä»»åŠ¡
result = agent_executor.invoke({"input": ""})

# 7. ä»»åŠ¡å®Œæˆåï¼Œè¾“å‡ºæç¤ºä¿¡æ¯
print("ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼å·²åˆ›å»ºllmè¯—è¯.txtå¹¶å†™å…¥è¯—è¯ã€‚")
```

è¿è¡Œç»“æœ

```
ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼å·²åˆ›å»ºllmè¯—è¯.txtå¹¶å†™å…¥è¯—è¯ã€‚
ã€Šæ™ºèå¤ä»Šã€‹

ç¡…æ™¶è„‰ç»œç»‡äº‘éœï¼Œ
ç®—æ³•å¦‚è¯—ç»˜ç‰©åã€‚
äººæ–‡æ™ºæ…§ç›¸è¾‰æ˜ ï¼Œ
æ•°å­—æ˜Ÿæ²³ç»½å¤èŠ±ã€‚

â€”â€”AIåˆ›ä½œäºæ•°å­—æ—¶ä»£
```

å¯ä»¥çœ‹åˆ°å¤§æ¨¡å‹æˆåŠŸåˆ›å»ºäº†æ–‡ä»¶ï¼Œå¹¶å†™äº†ä¸€é¦–è¯—ã€‚

Wooo~ æ˜¯ä¸æ˜¯çœ‹èµ·æ¥å¾ˆé…·ï¼Œå’Œé‚£ç§å¯¹è¯ç±»çš„æ™ºèƒ½ä½“æ„Ÿè§‰å°±ä¸ä¸€æ ·äº†~

å½“ç„¶ï¼Œlanchainå†…ç½®çš„å·¥å…·é™¤äº†æ–‡ä»¶æ“ä½œç±»ä»¥å¤–ï¼Œè¿˜æœ‰è®¡ç®—ç±»ã€æœç´¢ç±»ç­‰å·¥å…·ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾ï¼Œå®é™…ä½¿ç”¨æ—¶å¯ä»¥å†è¿›è¡Œç›¸å…³çš„æœç´¢

## 3.3. ç»¼åˆå®è·µï¼šæŠŠMemoryå’ŒToolç»„åˆèµ·æ¥

å‰é¢æˆ‘ä»¬åˆ†åˆ«å­¦äº†Memoryï¼ˆè®°å¿†ï¼‰å’ŒToolï¼ˆå·¥å…·ï¼‰ï¼Œä½†å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒä»¬ç»„åˆèµ·æ¥ï¼Œæ‰èƒ½æ„å»ºå‡ºæ›´å¼ºå¤§çš„æ™ºèƒ½åº”ç”¨ã€‚æ¯”å¦‚â€œå¸¦è®°å¿†çš„å®æ—¶ä¿¡æ¯æŸ¥è¯¢åŠ©æ‰‹â€â€”â€”æ—¢èƒ½è®°ä½ä½ çš„æŸ¥è¯¢å†å²ï¼Œåˆèƒ½å¸®ä½ æŸ¥å¤©æ°”ã€æŸ¥æ–°é—»ã€‚

### 3.3.1 å®è·µ1ï¼šå¸¦è®°å¿†çš„å¯¹è¯æœºå™¨äºº

æˆ‘ä»¬éƒ½çŸ¥é“å¤§è¯­è¨€æ¨¡å‹åœ¨æ•°å­¦è®¡ç®—ä¸Šçš„èƒ½åŠ›æ¯”è¾ƒå·®ï¼Œå› æ­¤æ™ºèƒ½ä½“å¯ä»¥å¼•å…¥è®¡ç®—å™¨æ¥å¢å¼ºå¤§æ¨¡å‹çš„è®¡ç®—èƒ½åŠ›ã€‚

ç›®æ ‡ï¼šæ„å»ºä¸€ä¸ªèƒ½è¿›è¡Œæ•°å­¦è®¡ç®—çš„å¯¹è¯åŠ©æ‰‹ï¼Œå®ç°è¿è´¯çš„åŠ©æ‰‹å¯¹è¯ã€‚

```python
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.runnables import RunnablePassthrough, RunnableLambda
from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_core.chat_history import BaseChatMessageHistory, InMemoryChatMessageHistory
from langchain_openai import ChatOpenAI  # è¡¥å……LLMå®šä¹‰
from langchain_experimental.tools import PythonREPLTool    # æ•°å­¦è®¡ç®—å·¥å…·
from langchain_core.messages import HumanMessage, AIMessage
from dotenv import load_dotenv
import re
import os

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()
API_KEY = os.getenv("API_KEY")
BASE_URL = "https://api.deepseek.com"

# åˆå§‹åŒ–LLMæ¨¡å‹
llm = ChatOpenAI(
    api_key=API_KEY,
    base_url=BASE_URL,
    model="deepseek-chat",
    temperature=0.3  # é™ä½éšæœºæ€§ï¼Œä¿è¯è¾“å‡ºç¨³å®š
)

# åˆå§‹åŒ–æ•°å­¦è®¡ç®—å·¥å…·ï¼ˆPythonREPLï¼‰
calc_tool = PythonREPLTool()
# çª—å£è®°å¿†å¤§å°ï¼šä¿ç•™æœ€è¿‘2è½®å¯¹è¯ï¼ˆæ¯è½®=ç”¨æˆ·+åŠ©æ‰‹æ¶ˆæ¯ï¼‰
WINDOW_SIZE = 2

# -------------------------- 2. å®šä¹‰æç¤ºè¯æ¨¡æ¿ï¼ˆé€‚é…çª—å£è®°å¿†+å·¥å…·è°ƒç”¨ï¼‰ --------------------------
prompt = ChatPromptTemplate.from_messages([
    ("system", """ä½ æ˜¯ä¸€åå‹å¥½çš„ä¸ªäººåŠ©æ‰‹åŠ©æ‰‹ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š
    1. èƒ½è®°ä½æœ€è¿‘{window_size}è½®å¯¹è¯å†…å®¹ï¼Œç”¨ç®€å•è¯­è¨€è§£ç­”é—®é¢˜ï¼›
    2. å¦‚æœé—®é¢˜åŒ…å«æ•°å­¦è®¡ç®—ï¼ˆå¦‚åŠ å‡ä¹˜é™¤ã€å…¬å¼ã€æ•°å€¼è¿ç®—ï¼‰ï¼Œå…ˆè°ƒç”¨è®¡ç®—å·¥å…·å¾—åˆ°ç»“æœï¼Œå†ç”¨è‡ªç„¶è¯­è¨€è§£é‡Šï¼›
    3. éè®¡ç®—é—®é¢˜ç›´æ¥å›ç­”ï¼Œè®°å¾—ç»“åˆå†å²å¯¹è¯ä¸Šä¸‹æ–‡ã€‚"""),
    MessagesPlaceholder(variable_name="chat_history"),  # çª—å£è®°å¿†æ³¨å…¥ç‚¹
    ("human", "{input}")  # ç”¨æˆ·æ–°é—®é¢˜
])

# -------------------------- 3. å·¥å…·è°ƒç”¨é€»è¾‘ï¼ˆåˆ¤æ–­æ˜¯å¦éœ€è¦è®¡ç®—ï¼‰ --------------------------
def judge_and_calc(inputs):
    """
    æ ¸å¿ƒé€»è¾‘ï¼š
    1. æ£€æµ‹ç”¨æˆ·é—®é¢˜æ˜¯å¦åŒ…å«æ•°å­¦è®¡ç®—éœ€æ±‚
    2. æ˜¯ï¼šè°ƒç”¨PythonREPLToolè®¡ç®—ï¼Œå†ç»“åˆLLMç”Ÿæˆå›ç­”
    3. å¦ï¼šç›´æ¥ç”¨LLMå›ç­”
    """
    user_input = inputs["input"]
    chat_history = inputs["chat_history"]
    
    # ç®€å•çš„è®¡ç®—æ„å›¾æ£€æµ‹ï¼ˆå¯æ ¹æ®éœ€æ±‚æ‰©å±•ï¼‰
    calc_pattern = r"(\+|\-|\Ã—|\*|Ã·|/|=|è®¡ç®—|æ±‚å’Œ|æ±‚å·®|å¹³æ–¹|ç«‹æ–¹|å¤šå°‘|ç­‰äº)"
    is_calc_needed = bool(re.search(calc_pattern, user_input))
    
    if is_calc_needed:
        # æ­¥éª¤1ï¼šè°ƒç”¨è®¡ç®—å·¥å…·æ‰§è¡Œè¿ç®—
        try:
            # æå–è®¡ç®—è¡¨è¾¾å¼ï¼ˆç®€åŒ–ç‰ˆï¼šå–æ•°å­—å’Œè¿ç®—ç¬¦éƒ¨åˆ†ï¼‰
            calc_expr = re.sub(r"[^\d\+\-\*\/\(\)\.]", "", user_input)
            if not calc_expr:
                calc_result = "æœªè¯†åˆ«åˆ°å¯è®¡ç®—çš„è¡¨è¾¾å¼"
            else:
                calc_result = calc_tool.run(calc_expr)
        except Exception as e:
            calc_result = f"è®¡ç®—å‡ºé”™ï¼š{str(e)}"
        
        # æ­¥éª¤2ï¼šæ„é€ åŒ…å«è®¡ç®—ç»“æœçš„æç¤ºï¼Œè®©LLMç”Ÿæˆè‡ªç„¶è¯­è¨€å›ç­”
        enhanced_input = f"""
        ç”¨æˆ·é—®é¢˜ï¼š{user_input}
        è®¡ç®—è¿‡ç¨‹/ç»“æœï¼š{calc_result}
        è¯·ç»“åˆè®¡ç®—ç»“æœï¼Œç”¨ç®€å•æ˜“æ‡‚çš„è¯­è¨€å›ç­”ç”¨æˆ·é—®é¢˜ï¼ŒåŒæ—¶å‚è€ƒå†å²å¯¹è¯ï¼š{chat_history}
        """
        inputs["input"] = enhanced_input
    return inputs

# -------------------------- 4. çª—å£è®°å¿†å®ç°ï¼ˆä»…ä¿ç•™æœ€è¿‘Nè½®ï¼‰ --------------------------
# ä¼šè¯å­˜å‚¨ï¼škey=session_idï¼Œvalue=InMemoryChatMessageHistory
window_memory_store = {}

def get_window_session_history(session_id: str) -> BaseChatMessageHistory:
    """è·å–å¸¦çª—å£é™åˆ¶çš„ä¼šè¯å†å²ï¼Œè‡ªåŠ¨æˆªæ–­è¶…å‡ºé•¿åº¦çš„æ¶ˆæ¯"""
    # åˆå§‹åŒ–ä¼šè¯è®°å¿†ï¼ˆæ— åˆ™åˆ›å»ºï¼‰
    if session_id not in window_memory_store:
        window_memory_store[session_id] = InMemoryChatMessageHistory()
    
    history = window_memory_store[session_id]
    # æˆªæ–­é€»è¾‘ï¼šä¿ç•™æœ€è¿‘WINDOW_SIZEè½®ï¼ˆæ¯è½®2æ¡æ¶ˆæ¯ï¼šHuman+AIï¼‰
    total_messages = len(history.messages)
    if total_messages > 2 * WINDOW_SIZE:
        history.messages = history.messages[-2 * WINDOW_SIZE:]  # åªä¿ç•™æœ€åNè½®
    
    return history

# -------------------------- 5. æ„å»ºå®Œæ•´çš„LCELé“¾ï¼ˆè®°å¿†+å·¥å…·+LLMï¼‰ --------------------------
# æ ¸å¿ƒé“¾ï¼šå‚æ•°ä¼ é€’ â†’ è®¡ç®—åˆ¤æ–­ â†’ æç¤ºè¯æ‹¼æ¥ â†’ LLMç”Ÿæˆ
chain = (
    RunnablePassthrough.assign(
        chat_history=lambda x: x["chat_history"]  # ä¼ é€’çª—å£è®°å¿†
    )
    | RunnableLambda(judge_and_calc)  # æ³¨å…¥è®¡ç®—å·¥å…·è°ƒç”¨é€»è¾‘
    | prompt  # æ‹¼æ¥â€œçª—å£è®°å¿†+å¢å¼ºè¾“å…¥â€
    | llm  # è°ƒç”¨LLMç”Ÿæˆæœ€ç»ˆå›ç­”
)

# æ³¨å…¥çª—å£è®°å¿†åŠŸèƒ½
chain_with_window_memory = RunnableWithMessageHistory(
    runnable=chain,
    get_session_history=get_window_session_history,
    input_messages_key="input",
    history_messages_key="chat_history",
    output_messages_key="output"
)

# -------------------------- 6. å¤šè½®å¯¹è¯æµ‹è¯• --------------------------
if __name__ == "__main__":
    session_id = "student_001"  # æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ä¼šè¯IDï¼Œè®°å¿†éš”ç¦»
    print("===== å¸¦çª—å£è®°å¿†çš„æ•°å­¦è®¡ç®—æ™ºèƒ½åŠ©æ‰‹ =====")
    print("æ”¯æŒï¼šå¤šè½®å¯¹è¯ã€ä»…ä¿ç•™æœ€è¿‘2è½®è®°å¿†ã€è‡ªåŠ¨æ•°å­¦è®¡ç®—")
    print("è¾“å…¥'é€€å‡º'ç»“æŸå¯¹è¯\n")
    
    while True:
        user_input = input("ä½ ï¼š")
        if user_input in ["é€€å‡º", "quit", "q"]:
            print("åŠ©æ‰‹ï¼šå†è§ï¼æœ‰é—®é¢˜éšæ—¶é—®æˆ‘ï½")
            break
        
        # è°ƒç”¨å¸¦çª—å£è®°å¿†çš„æ™ºèƒ½ä½“
        response = chain_with_window_memory.invoke(
            {"input": user_input, "window_size": WINDOW_SIZE},
            config={"configurable": {"session_id": session_id}}
        )
        
        # è¾“å‡ºå›ç­”ï¼ˆå¹¶å°†å¯¹è¯å­˜å…¥è®°å¿†ï¼‰
        print(f"åŠ©æ‰‹ï¼š{response.content}\n")
```

> ã€LCELä¼˜åŠ¿ã€‘ç”¨ç®¡é“ç¬¦ç»„åˆç»„ä»¶ï¼Œé€»è¾‘éå¸¸æ¸…æ™°ï¼Œåç»­è¦åŠ å·¥å…·çš„è¯ï¼Œåªéœ€è¦åœ¨é“¾è·¯ä¸Šå†åŠ ä¸€ä¸ª`| å·¥å…·ç»„ä»¶`ï¼Œä¸ç”¨é‡æ„æ•´ä¸ªä»£ç ï¼Œéå¸¸çµæ´»ã€‚
>
> éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPythonREPLTool å¯æ‰§è¡Œä»»æ„ä»£ç ï¼Œç”Ÿäº§ç¯å¢ƒéœ€é™åˆ¶å¯æ‰§è¡Œçš„è¡¨è¾¾å¼ï¼ˆå¦‚ä»…å…è®¸åŠ å‡ä¹˜é™¤ï¼‰ã€‚

è¿è¡Œç»“æœ

```
ä½ ï¼š168*12ç­‰äºå¤šå°‘
Python REPL can execute arbitrary code. Use with caution.
åŠ©æ‰‹ï¼šå°ç†Šï¼Œæˆ‘å¸®ä½ ç®—äº†ä¸€ä¸‹ï¼š

å¯ä»¥è¿™æ ·ç†è§£ï¼š
168 Ã— 10 = 1680ï¼Œå†åŠ ä¸Š 168 Ã— 2 = 336ï¼Œ
1680 + 336 = 2016ã€‚

æœ‰å…¶ä»–é—®é¢˜éšæ—¶å‘Šè¯‰æˆ‘å“¦ï¼ ğŸ˜Š

ä½ ï¼šä½ ï¼š2å¼€æ–¹æ˜¯å¤šå°‘
åŠ©æ‰‹ï¼šå°ç†Šï¼Œ2çš„å¹³æ–¹æ ¹çº¦ç­‰äº **1.414**ï¼ˆæ›´ç²¾ç¡®å€¼æ˜¯æ— é™ä¸å¾ªç¯å°æ•°ï¼‰ã€‚
å¯ä»¥è¿™æ ·ç†è§£ï¼š
å¦‚æœä¸€ä¸ªæ­£æ–¹å½¢çš„é¢ç§¯æ˜¯2ï¼Œå®ƒçš„è¾¹é•¿å°±æ˜¯âˆš2 â‰ˆ 1.414ã€‚

éœ€è¦ç®—å…¶ä»–æ•°çš„è¯ï¼Œéšæ—¶å‘Šè¯‰æˆ‘å“¦ï¼ ğŸ˜Š

ä½ ï¼šæˆ‘æ˜¯è°
åŠ©æ‰‹ï¼šå°ç†Šï¼Œæ ¹æ®æˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯ï¼Œæˆ‘åªçŸ¥é“ä½ æ˜¯æ­£åœ¨å’Œæˆ‘èŠå¤©çš„ç”¨æˆ·ï¼Œä½†ä½ æ²¡æœ‰å‘Šè¯‰æˆ‘ä½ çš„åå­—æˆ–èº«ä»½å‘€ï½

å¦‚æœä½ æƒ³è®©æˆ‘è®°ä½ä½ çš„ç§°å‘¼æˆ–ä¿¡æ¯ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘å“¦ï¼æˆ‘ä¼šå°½åŠ›åœ¨æ¥ä¸‹æ¥çš„å¯¹è¯ä¸­ç•™æ„ã€‚ ğŸ˜Š

ä½ ï¼š668å¼€æ–¹æ˜¯å¤šå°‘
åŠ©æ‰‹ï¼šå°ç†Šï¼Œ668çš„å¹³æ–¹æ ¹çº¦ç­‰äº **25.8457**ï¼ˆä¿ç•™å››ä½å°æ•°ï¼‰ã€‚

å¯ä»¥è¿™æ ·ç†è§£ï¼š
å¦‚æœä¸€ä¸ªæ­£æ–¹å½¢çš„é¢ç§¯æ˜¯668ï¼Œå®ƒçš„è¾¹é•¿å°±æ˜¯âˆš668 â‰ˆ 25.85å·¦å³ã€‚

å’Œä¹‹å‰ç®—çš„âˆš2ç±»ä¼¼ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ— é™ä¸å¾ªç¯å°æ•°ï¼Œé€šå¸¸å–è¿‘ä¼¼å€¼ä½¿ç”¨ã€‚

éœ€è¦ç®—å…¶ä»–æ•°çš„è¯ï¼Œç»§ç»­å–Šæˆ‘ï½ ğŸ˜Š
```

### 3.3.2 å®è·µ2ï¼šå¸¦è®°å¿†çš„æ–‡ä»¶å¤¹æ“ä½œåŠ©æ‰‹

ToolMessage æ˜¯å·¥å…·è°ƒç”¨çš„ç»“æœæ¶ˆæ¯ï¼Œä¼šè¢«åŠ å…¥å¯¹è¯å†å²ï¼Œè®© LLM åç»­èƒ½å‚è€ƒå·¥å…·æ‰§è¡Œç»“æœå›ç­”é—®é¢˜

ç›®æ ‡ï¼šæ„å»ºä¸€ä¸ªèƒ½æŸ¥çœ‹æ–‡ä»¶ã€åˆ›å»ºæ–‡ä»¶ã€å†™å…¥æ–‡ä»¶çš„æ–‡ä»¶åŠ©æ‰‹ã€‚æ ¸å¿ƒç»„åˆï¼š`Memory + Tool + Agent + LLM`

```python
# =========================
# 1. åŸºç¡€ä¾èµ–
# =========================
import os
from dotenv import load_dotenv
from typing import Optional

from langchain_openai import ChatOpenAI
from langchain_core.tools import tool
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.runnables import RunnableWithMessageHistory
from langchain_core.chat_history import InMemoryChatMessageHistory, BaseChatMessageHistory
from langchain_core.messages import AIMessage, ToolMessage

# =========================
# 2. ç¯å¢ƒå˜é‡ & æ¨¡å‹
# =========================
load_dotenv()

llm = ChatOpenAI(
    api_key=os.getenv("API_KEY"),
    base_url="https://api.deepseek.com",
    model="deepseek-chat",
    temperature=0.3
)

# =========================
# 3. çª—å£è®°å¿†
# =========================
WINDOW_SIZE = 3
memory_store = {}

def get_session_history(session_id: str) -> BaseChatMessageHistory:
    if session_id not in memory_store:
        memory_store[session_id] = InMemoryChatMessageHistory()

    history = memory_store[session_id]
    if len(history.messages) > 2 * WINDOW_SIZE:
        history.messages = history.messages[-2 * WINDOW_SIZE:]
    return history

# =========================
# 4. å®šä¹‰å·¥å…·ï¼ˆ@toolï¼‰
# =========================
@tool
def list_files(path: str = ".") -> str:
    """æŸ¥çœ‹æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨"""
    try:
        if not os.path.exists(path):
            return f"è·¯å¾„ä¸å­˜åœ¨ï¼š{path}"

        items = os.listdir(path)
        if not items:
            return "ç›®å½•ä¸ºç©º"

        result = []
        for item in items:
            full = os.path.join(path, item)
            if os.path.isfile(full):
                result.append(f"æ–‡ä»¶ï¼š{item}ï¼ˆ{os.path.getsize(full)} å­—èŠ‚ï¼‰")
            else:
                result.append(f"æ–‡ä»¶å¤¹ï¼š{item}")
        return "\n".join(result)
    except Exception as e:
        return f"æŸ¥çœ‹å¤±è´¥ï¼š{e}"

@tool
def create_file(path: str, content: str = "") -> str:
    """åˆ›å»ºæ–‡ä»¶ï¼Œå¹¶å¯å†™å…¥åˆå§‹å†…å®¹"""
    try:
        folder = os.path.dirname(path)
        if folder and not os.path.exists(folder):
            os.makedirs(folder)

        with open(path, "w", encoding="utf-8") as f:
            f.write(content)

        return f"æ–‡ä»¶å·²åˆ›å»ºï¼š{path}"
    except Exception as e:
        return f"åˆ›å»ºå¤±è´¥ï¼š{e}"

@tool
def write_file(path: str, content: str, append: bool = True) -> str:
    """å‘æ–‡ä»¶å†™å…¥å†…å®¹ï¼Œæ”¯æŒè¿½åŠ æˆ–è¦†ç›–"""
    try:
        if not os.path.exists(path):
            return f"æ–‡ä»¶ä¸å­˜åœ¨ï¼š{path}"

        mode = "a" if append else "w"
        with open(path, mode, encoding="utf-8") as f:
            f.write(content)

        return f"å†™å…¥æˆåŠŸï¼ˆ{'è¿½åŠ ' if append else 'è¦†ç›–'}ï¼‰"
    except Exception as e:
        return f"å†™å…¥å¤±è´¥ï¼š{e}"

@tool
def delete_file(path: str) -> str:
    """åˆ é™¤æ–‡ä»¶æˆ–ç©ºæ–‡ä»¶å¤¹"""
    try:
        if not os.path.exists(path):
            return f"è·¯å¾„ä¸å­˜åœ¨ï¼š{path}"

        if os.path.isfile(path):
            os.remove(path)
            return f"æ–‡ä»¶å·²åˆ é™¤ï¼š{path}"

        if os.path.isdir(path):
            if os.listdir(path):
                return "æ–‡ä»¶å¤¹éç©ºï¼Œæ— æ³•åˆ é™¤"
            os.rmdir(path)
            return f"æ–‡ä»¶å¤¹å·²åˆ é™¤ï¼š{path}"

        return "æ— æ•ˆè·¯å¾„"
    except Exception as e:
        return f"åˆ é™¤å¤±è´¥ï¼š{e}"

tools = [list_files, create_file, write_file, delete_file]

# =========================
# 5. Promptï¼ˆå‘Šè¯‰æ¨¡å‹ï¼šä½ å¯ä»¥ç”¨å·¥å…·ï¼‰
# =========================
prompt = ChatPromptTemplate.from_messages([
    ("system",
     "ä½ æ˜¯ä¸€ä¸ªæ–‡ä»¶æ“ä½œæ™ºèƒ½åŠ©æ‰‹ã€‚"
     "å½“ç”¨æˆ·è¯·æ±‚æ¶‰åŠæ–‡ä»¶æˆ–ç›®å½•æ“ä½œæ—¶ï¼Œä½ å¯ä»¥è‡ªä¸»å†³å®šæ˜¯å¦è°ƒç”¨å·¥å…·ã€‚"
     "å¦‚æœä¸éœ€è¦å·¥å…·ï¼Œç›´æ¥å›ç­”ç”¨æˆ·ã€‚"),
    MessagesPlaceholder(variable_name="chat_history"),
    ("human", "{input}")
])

# =========================
# 6. æ„å»º Tool-Calling Agent
# =========================
agent = prompt | llm.bind_tools(tools)

agent_with_memory = RunnableWithMessageHistory(
    runnable=agent,
    get_session_history=get_session_history,
    input_messages_key="input",
    history_messages_key="chat_history"
)

if __name__ == "__main__":
    session_id = "tool_agent_demo"

    print("===== ğŸ§  Tool Calling æ–‡ä»¶ Agent =====")
    print("ç¤ºä¾‹ï¼š")
    print(" - æŸ¥çœ‹å½“å‰æ–‡ä»¶å¤¹")
    print(" - åˆ›å»ºæ–‡ä»¶ test.txt å†…å®¹ Hello")
    print(" - å†™å…¥æ–‡ä»¶ test.txt å†…å®¹ World è¿½åŠ ")
    print(" - åˆ é™¤æ–‡ä»¶ test.txt")
    print("è¾“å…¥ q é€€å‡º\n")

    while True:
        user_input = input("ä½ ï¼š")
        if user_input.lower() in ["q", "quit", "é€€å‡º"]:
            print("åŠ©æ‰‹ï¼šå†è§ ğŸ‘‹")
            break

        # ===== ç¬¬ä¸€æ¬¡ï¼šæ¨¡å‹æ€è€ƒ =====
        result = agent_with_memory.invoke(
            {"input": user_input},
            config={"configurable": {"session_id": session_id}}
        )

        history = get_session_history(session_id)

        print("\nğŸ§ ã€æ¨¡å‹è¾“å‡ºã€‘")
        if result.content:
            print(result.content)

        # ===== æ¨¡å‹å†³å®šè°ƒç”¨å·¥å…· =====
        if isinstance(result, AIMessage) and result.tool_calls:
            print("\nğŸ”§ã€æ¨¡å‹å†³å®šè°ƒç”¨å·¥å…·ã€‘")
            for call in result.tool_calls:
                tool_name = call["name"]
                tool_args = call["args"]

                print(f"â¡ï¸ å·¥å…·åï¼š{tool_name}")
                print(f"â¡ï¸ å‚æ•°ï¼š{tool_args}")

                tool_func = next(t for t in tools if t.name == tool_name)
                observation = tool_func.invoke(tool_args)

                print("\nğŸ“¦ã€å·¥å…·æ‰§è¡Œç»“æœã€‘")
                print(observation)

                history.add_message(
                    ToolMessage(
                        tool_call_id=call["id"],
                        content=str(observation)
                    )
                )

            print("\nâœ…ã€æœ¬è½®ç»“æŸï¼šå·¥å…·æ‰§è¡Œå®Œæˆã€‘\n")
            continue  # å›åˆ° while True ç­‰ç”¨æˆ·è¾“å…¥

        # ===== æœ€ç»ˆå›ç­”ï¼ˆæ²¡æœ‰å·¥å…·è°ƒç”¨ï¼‰ =====
        print("\nâœ…ã€æœ€ç»ˆå›ç­”ã€‘")
        print(result.content, "\n")

```

è¿è¡Œç»“æœ

```
ç¤ºä¾‹ï¼š
 - æŸ¥çœ‹å½“å‰æ–‡ä»¶å¤¹
 - åˆ›å»ºæ–‡ä»¶ test.txt å†…å®¹ Hello
 - å†™å…¥æ–‡ä»¶ test.txt å†…å®¹ World è¿½åŠ 
è¾“å…¥ q é€€å‡º

ä½ ï¼šæŸ¥çœ‹å½“å‰æ–‡ä»¶å¤¹

ğŸ§ ã€æ¨¡å‹è¾“å‡ºã€‘
æˆ‘æ¥æŸ¥çœ‹å½“å‰æ–‡ä»¶å¤¹çš„å†…å®¹ã€‚

ğŸ”§ã€æ¨¡å‹å†³å®šè°ƒç”¨å·¥å…·ã€‘
â¡ï¸ å·¥å…·åï¼šlist_files
â¡ï¸ å‚æ•°ï¼š{'path': '.'}

ğŸ“¦ã€å·¥å…·æ‰§è¡Œç»“æœã€‘
æ–‡ä»¶å¤¹ï¼šeasy-langent
æ–‡ä»¶ï¼šllmè¯—è¯.txtï¼ˆ157 å­—èŠ‚ï¼‰
âœ…ã€æœ¬è½®ç»“æŸï¼šå·¥å…·æ‰§è¡Œå®Œæˆã€‘

ä½ ï¼šåˆ›å»ºä¸€ä¸ªå«test.txtçš„æ–‡ä»¶ å¹¶åœ¨é‡Œé¢å†™ä¸€é¦–è¯—

ğŸ§ ã€æ¨¡å‹è¾“å‡ºã€‘
æˆ‘æ¥åˆ›å»ºä¸€ä¸ªåä¸ºtest.txtçš„æ–‡ä»¶ï¼Œå¹¶åœ¨é‡Œé¢å†™ä¸€é¦–è¯—ã€‚

ğŸ”§ã€æ¨¡å‹å†³å®šè°ƒç”¨å·¥å…·ã€‘
â¡ï¸ å·¥å…·åï¼šcreate_file
â¡ï¸ å‚æ•°ï¼š{'path': 'test.txt', 'content': 'ã€Šé™å¤œæ€ã€‹\næç™½\n\nåºŠå‰æ˜æœˆå…‰ï¼Œ\nç–‘æ˜¯åœ°ä¸Šéœœã€‚\nä¸¾å¤´æœ›æ˜æœˆï¼Œ\nä½å¤´æ€æ•…ä¹¡ã€‚\n\nã€Šæ˜¥æ™“ã€‹\nå­Ÿæµ©ç„¶\n\næ˜¥çœ ä¸è§‰æ™“ï¼Œ\nå¤„å¤„é—»å•¼é¸Ÿã€‚\nå¤œæ¥é£é›¨å£°ï¼Œ\nèŠ±è½çŸ¥å¤šå°‘ã€‚'}

ğŸ“¦ã€å·¥å…·æ‰§è¡Œç»“æœã€‘
æ–‡ä»¶å·²åˆ›å»ºï¼štest.txt


ä½ ï¼šæŸ¥çœ‹å½“å‰æ–‡ä»¶å¤¹

ğŸ§ ã€æ¨¡å‹è¾“å‡ºã€‘
æˆ‘æ¥æŸ¥çœ‹å½“å‰æ–‡ä»¶å¤¹çš„å†…å®¹ï¼Œç¡®è®¤test.txtæ–‡ä»¶æ˜¯å¦å·²åˆ›å»ºæˆåŠŸã€‚

ğŸ”§ã€æ¨¡å‹å†³å®šè°ƒç”¨å·¥å…·ã€‘
â¡ï¸ å·¥å…·åï¼šlist_files
â¡ï¸ å‚æ•°ï¼š{'path': '.'}

ğŸ“¦ã€å·¥å…·æ‰§è¡Œç»“æœã€‘
æ–‡ä»¶å¤¹ï¼šeasy-langent
æ–‡ä»¶ï¼šllmè¯—è¯.txtï¼ˆ157 å­—èŠ‚ï¼‰
æ–‡ä»¶ï¼štest.txtï¼ˆ214 å­—èŠ‚ï¼‰

âœ…ã€æœ¬è½®ç»“æŸï¼šå·¥å…·æ‰§è¡Œå®Œæˆã€‘

ä½ ï¼šä½ æ˜¯è°

ğŸ§ ã€æ¨¡å‹è¾“å‡ºã€‘
æˆ‘æ˜¯ä¸€ä¸ªæ–‡ä»¶æ“ä½œæ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®åŠ©æ‚¨è¿›è¡Œæ–‡ä»¶ç›¸å…³çš„æ“ä½œï¼Œæ¯”å¦‚ï¼š

1. æŸ¥çœ‹ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨
2. åˆ›å»ºæ–‡ä»¶å¹¶å†™å…¥å†…å®¹
3. å‘æ–‡ä»¶å†™å…¥å†…å®¹ï¼ˆæ”¯æŒè¿½åŠ æˆ–è¦†ç›–æ¨¡å¼ï¼‰

åˆšæ‰æˆ‘å·²ç»æŒ‰ç…§æ‚¨çš„è¦æ±‚åˆ›å»ºäº†ä¸€ä¸ªåä¸ºtest.txtçš„æ–‡ä»¶ï¼Œå¹¶åœ¨é‡Œé¢å†™äº†ä¸¤é¦–ç»å…¸çš„ä¸­å›½å¤è¯—ï¼šæç™½çš„ã€Šé™å¤œæ€ã€‹å’Œå­Ÿæµ©ç„¶çš„ã€Šæ˜¥æ™“ã€‹ã€‚

æ‚¨å¯ä»¥çœ‹åˆ°å½“å‰æ–‡ä»¶å¤¹ä¸­æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼šllmè¯—è¯.txtå’Œtest.txtã€‚å¦‚æœæ‚¨éœ€è¦å¯¹è¿™äº›æ–‡ä»¶è¿›è¡Œå…¶ä»–æ“ä½œï¼Œæ¯”å¦‚æŸ¥çœ‹å†…å®¹ã€ä¿®æ”¹å†…å®¹æˆ–åˆ é™¤æ–‡ä»¶ï¼Œæˆ‘éƒ½å¯ä»¥å¸®åŠ©æ‚¨å¤„ç†ã€‚

âœ…ã€æœ€ç»ˆå›ç­”ã€‘
æˆ‘æ˜¯ä¸€ä¸ªæ–‡ä»¶æ“ä½œæ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®åŠ©æ‚¨è¿›è¡Œæ–‡ä»¶ç›¸å…³çš„æ“ä½œï¼Œæ¯”å¦‚ï¼š

1. æŸ¥çœ‹ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨
2. åˆ›å»ºæ–‡ä»¶å¹¶å†™å…¥å†…å®¹
3. å‘æ–‡ä»¶å†™å…¥å†…å®¹ï¼ˆæ”¯æŒè¿½åŠ æˆ–è¦†ç›–æ¨¡å¼ï¼‰
4. åˆ é™¤æ–‡ä»¶æˆ–ç©ºæ–‡ä»¶å¤¹

åˆšæ‰æˆ‘å·²ç»æŒ‰ç…§æ‚¨çš„è¦æ±‚åˆ›å»ºäº†ä¸€ä¸ªåä¸ºtest.txtçš„æ–‡ä»¶ï¼Œå¹¶åœ¨é‡Œé¢å†™äº†ä¸¤é¦–ç»å…¸çš„ä¸­å›½å¤è¯—ï¼šæç™½çš„ã€Šé™å¤œæ€ã€‹å’Œå­Ÿæµ©ç„¶çš„ã€Šæ˜¥æ™“ã€‹ã€‚

æ‚¨å¯ä»¥çœ‹åˆ°å½“å‰æ–‡ä»¶å¤¹ä¸­æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼šllmè¯—è¯.txtå’Œtest.txtã€‚å¦‚æœæ‚¨éœ€è¦å¯¹è¿™äº›æ–‡ä»¶è¿›è¡Œå…¶ä»–æ“ä½œï¼Œæ¯”å¦‚æŸ¥çœ‹å†…å®¹ã€ä¿®æ”¹å†…å®¹æˆ–åˆ é™¤æ–‡ä»¶ï¼Œæˆ‘éƒ½å¯ä»¥å¸®åŠ©æ‚¨å¤„ç†ã€‚
```

Wooo~ æ˜¯ä¸æ˜¯çœ‹èµ·æ¥å¾ˆé…·ï¼Œè¿™æ˜¯ä½ è‡ªå·±å®ç°çš„å¸¦æœ‰è®°å¿†åŠŸèƒ½æ™ºèƒ½ä½“ï¼Œå®ƒèƒ½è‡ªä¸»å†³å®šä½¿ç”¨å“ªäº›å·¥å…·ã€‚åœ¨å®é™…çš„ä¼ä¸šä¸­ï¼Œä¼šæœ‰å¾ˆå¤šè·¯ç”±å’Œå·¥å…·æ¨¡å—ï¼Œè¿™æ ·èƒ½è¿›ä¸€æ­¥æé«˜æ¨¡å‹çš„èƒ½åŠ›ã€‚

### 3.3.3 ç»„åˆå®è·µæ€»ç»“

é€šè¿‡è¿™ä¸¤ä¸ªå®è·µæ¡ˆä¾‹ï¼Œæˆ‘ä»¬èƒ½æ€»ç»“å‡ºç»„ä»¶ç»„åˆçš„æ ¸å¿ƒæ€è·¯â€”â€”â€œæ¨¡å—åŒ–æ‹†åˆ†+æµæ°´çº¿ç»„åˆâ€ï¼š

- æ‹†åˆ†ï¼šæŠŠåº”ç”¨æ‹†æˆç‹¬ç«‹çš„â€œå°æ¨¡å—â€â€”â€”è®°å¿†ï¼ˆç®¡çŠ¶æ€ï¼‰ã€å·¥å…·ï¼ˆç®¡è¡ŒåŠ¨ï¼‰ã€æé—®æ¨¡æ¿ï¼ˆç®¡è¾“å…¥ï¼‰ã€LLMï¼ˆç®¡æ€è€ƒï¼‰ï¼›
- ç»„åˆï¼šç”¨LCELçš„ç®¡é“ç¬¦ï¼ˆ|ï¼‰æŠŠæ¨¡å—ä¸²æˆæµæ°´çº¿ï¼Œæ¯”å¦‚â€œç”¨æˆ·è¾“å…¥ â†’ è®°å¿†æå– â†’ æé—®æ‹¼æ¥ â†’ Agentå†³ç­– â†’ å·¥å…·è°ƒç”¨ â†’ LLMå›ç­” â†’ è®°å¿†ä¿å­˜â€ï¼›
- æ‰©å±•ï¼šè¦åŠ æ–°åŠŸèƒ½ï¼Œåªéœ€åŠ æ–°æ¨¡å—ï¼ˆæ¯”å¦‚åŠ ç¿»è¯‘åŠŸèƒ½å°±åŠ ç¿»è¯‘å·¥å…·ï¼‰ï¼Œä¸ç”¨æ”¹æ•´ä¸ªæµæ°´çº¿ï¼Œå¼€å‘æ•ˆç‡å¾ˆé«˜ã€‚

## 3.4 æœ¬ç« å°ç»“

åˆ°è¿™é‡Œï¼Œæœ¬ç« çš„å†…å®¹å°±å…¨éƒ¨å­¦å®Œäº†ã€‚æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼š

1. Memoryç»„ä»¶ï¼šè§£å†³LLMâ€œå¥å¿˜â€çš„é—®é¢˜ï¼Œé‡ç‚¹æŒæ¡ä¸‰ç§å¸¸ç”¨ç»„ä»¶ï¼ˆå…¨é‡ã€çª—å£ã€æ‘˜è¦ï¼‰çš„é€‚ç”¨åœºæ™¯å’Œç”¨æ³•ï¼›
2. Toolç»„ä»¶ï¼šç»™LLMè£…â€œæ‰‹è„šâ€ï¼Œè®©å®ƒèƒ½è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼Œé‡ç‚¹æŒæ¡å†…ç½®å·¥å…·çš„ä½¿ç”¨å’Œè‡ªå®šä¹‰å·¥å…·çš„è§„èŒƒï¼›
3. ç»„ä»¶ç»„åˆï¼šç”¨LCELå®ç°æ¨¡å—æµæ°´çº¿ï¼Œé‡ç‚¹æŒæ¡â€œè®°å¿†+å·¥å…·+Agentâ€çš„ç»„åˆæ€è·¯ï¼Œèƒ½æ„å»ºå¸¦è®°å¿†ã€èƒ½è¡ŒåŠ¨çš„å¤æ‚åº”ç”¨ã€‚

æ¥ä¸‹æ¥çš„å­¦ä¹ é‡ç‚¹ï¼šAgentçš„é«˜çº§ç”¨æ³•ï¼ˆæ¯”å¦‚å¤šå·¥å…·ååŒã€å¤æ‚ä»»åŠ¡è§„åˆ’ï¼‰ï¼Œè¿™æ˜¯æ„å»ºæ™ºèƒ½åº”ç”¨çš„æ ¸å¿ƒèƒ½åŠ›ã€‚å¤§å®¶å¯ä»¥å…ˆè¯•ç€æ‰©å±•ä»Šå¤©çš„å®è·µæ¡ˆä¾‹ï¼Œå·©å›ºä¸€ä¸‹æœ¬ç« çš„çŸ¥è¯†ï¼

## 3.5 æœ¬ç« ç»ƒä¹ 

1. å¤ç°æœ¬ç« æ ¸å¿ƒæ¡ˆä¾‹ï¼šè®°å¿†æ¨¡å—ã€å·¥å…·æ¨¡å—ï¼Œç¡®ä¿æ‰€æœ‰æ¡ˆä¾‹å‡å¯æˆåŠŸè¿è¡Œå¹¶è¾“å‡ºé¢„æœŸç»“æœï¼›
2. ç»¼åˆå®è·µé€‰æ‹© 1 ä¸ªæ¡ˆä¾‹åœ¨æœ¬åœ°å¤ä¹ ï¼Œç¡®ä¿æ‰€æœ‰æ¡ˆä¾‹å¯æˆåŠŸè¿è¡Œå¹¶è¾“å‡ºé¢„æœŸç»“æœï¼›
3. æ€è€ƒä¼ä¸šè½åœ°ä¼˜åŒ–æ–¹å‘ï¼š
   - è®°å¿†å±‚ï¼šç”¨ Redis/PostgreSQL æ›¿ä»£å†…å­˜å­˜å‚¨ï¼Œå®ç°è®°å¿†æŒä¹…åŒ–ï¼›
   - å·¥å…·å±‚ï¼šå¢åŠ æƒé™æ§åˆ¶ã€é‡è¯•æœºåˆ¶ã€å¼‚å¸¸æ•è·ï¼ˆå¦‚æ–‡ä»¶å†™å…¥å¤±è´¥æç¤ºï¼‰ï¼›
   - æ€§èƒ½å±‚ï¼šç¼“å­˜é«˜é¢‘å·¥å…·è°ƒç”¨ç»“æœã€é™åˆ¶è®°å¿†é•¿åº¦æ§åˆ¶ Token æ¶ˆè€—ï¼›
   - ä½“éªŒå±‚ï¼šä¼˜åŒ–å·¥å…·è°ƒç”¨è¯æœ¯ï¼Œè®©å›ç­”æ›´è‡ªç„¶ã€‚